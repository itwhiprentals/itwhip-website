// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================================================
// USER & AUTHENTICATION MODELS
// ============================================================================

model User {
  id     String     @id @default(cuid())
  email  String?    @unique
  name   String?
  role   UserRole   @default(ANONYMOUS)
  status UserStatus @default(ACTIVE)

  // Dual-Role Account Linking (NEW)
  // When user has both host and guest accounts, BOTH User records share the same legacyDualId
  // This allows seamless role switching while keeping separate userIds for security
  legacyDualId String?

  // Authentication
  passwordHash     String?
  emailVerified    Boolean? @default(false)
  phoneVerified    Boolean  @default(false)
  isActive         Boolean  @default(true)
  twoFactorEnabled Boolean  @default(false)

  // Email Verification
  emailVerificationCode   String?
  emailVerificationExpiry DateTime?

  // Account Deletion (GDPR)
  deletionRequestedAt  DateTime?
  deletionScheduledFor DateTime?
  deletionReason       String?

  // Account Lockout
  failedLoginAttempts Int       @default(0)
  lastFailedLoginAt   DateTime?
  lockedUntil         DateTime?

  // PASSWORD RESET FIELDS
  resetToken               String?   @unique
  resetTokenExpiry         DateTime?
  resetTokenUsed           Boolean   @default(false)
  lastPasswordReset        DateTime?
  passwordResetAttempts    Int       @default(0)
  passwordResetLastAttempt DateTime?

  // Profile
  jobTitle String?
  phone    String?
  avatar   String?
  image    String? // Required by NextAuth PrismaAdapter

  // Relationships
  hotelId String?
  hotel   Hotel?  @relation(fields: [hotelId], references: [id])

  // Rental relationships
  rentalHost      RentalHost?
  rentalBookings  RentalBooking[]  @relation("RenterBookings")
  reviewerProfile ReviewerProfile?

  // Security
  sessions      Session[]
  apiKeys       ApiKey[]
  loginAttempts LoginAttempt[]
  auditLogs     AuditLog[]
  activityLogs  ActivityLog[]

  // Notifications
  notificationDismissals NotificationDismissal[]
  notificationSettings   UserNotificationSettings?

  // Payment methods
  paymentMethods PaymentMethod[] @relation("UserPaymentMethods")

  // GDPR Data Exports
  dataExports DataExportLog[]

  // Timestamps
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  lastActive DateTime?

  // OAuth Accounts
  accounts Account[]

  @@index([email])
  @@index([hotelId])
  @@index([role])
  @@index([status])
  @@index([resetToken])
  @@index([legacyDualId])
}

// OAuth Account model for NextAuth.js
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model UserNotificationSettings {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  claimFiled       Boolean @default(true)
  claimApproved    Boolean @default(true)
  claimDenied      Boolean @default(true)
  fnolSubmitted    Boolean @default(true)
  guestHoldNotice  Boolean @default(true)
  responseReminder Boolean @default(true)
  claimResolved    Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

model DataExportLog {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  requestedAt DateTime  @default(now())
  completedAt DateTime?
  downloadUrl String?
  expiresAt   DateTime?
  status      String    @default("pending") // pending, completed, expired
  fileSize    Int?

  @@index([userId])
  @@index([status])
}

model NotificationDismissal {
  id               String    @id @default(cuid())
  userId           String
  notificationType String
  dismissedAt      DateTime  @default(now())
  dismissCount     Int       @default(1)
  completedAt      DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, notificationType])
  @@index([userId])
  @@index([dismissedAt])
}

model Session {
  id     String  @id @default(cuid())
  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Session data
  token        String  @unique
  refreshToken String? @unique
  tokenFamily  String?

  // Device info
  ipAddress   String
  userAgent   String
  deviceId    String?
  fingerprint String?

  // Validity
  expiresAt DateTime
  revokedAt DateTime?

  createdAt    DateTime @default(now())
  lastActivity DateTime @default(now())

  @@index([token])
  @@index([refreshToken])
  @@index([userId])
}

model ApiKey {
  id   String @id @default(cuid())
  key  String @unique
  name String

  // Owner
  userId  String
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  hotelId String?
  hotel   Hotel?  @relation(fields: [hotelId], references: [id])

  // Permissions - JSON
  permissions String
  tier        CertificationTier?

  // Rate limiting
  rateLimit  Int    @default(1000)
  rateWindow String @default("hour")

  // Usage tracking
  lastUsed   DateTime?
  usageCount Int       @default(0)

  // Status
  active    Boolean   @default(true)
  expiresAt DateTime?

  createdAt DateTime @default(now())

  @@index([key])
  @@index([hotelId])
}

// ============================================================================
// HOTEL MODELS
// ============================================================================

model Hotel {
  id      String @id @default(cuid())
  gdsCode String @unique
  name    String

  // Property details
  type  PropertyType
  size  HotelSize
  rooms Int
  stars Int?
  chain String?

  // Location
  address   String
  city      String
  state     String
  zip       String
  country   String
  latitude  Float?
  longitude Float?

  // Platform status
  claimed   Boolean   @default(false)
  claimedBy String?
  claimedAt DateTime?

  certified           Boolean            @default(false)
  certificationTier   CertificationTier?
  certifiedAt         DateTime?
  certificationExpiry DateTime?

  active Boolean @default(true)

  // Relationships
  users    User[]
  bookings Booking[]
  rides    Ride[]
  revenue  Revenue[]
  metrics  HotelMetrics[]
  apiKeys  ApiKey[]

  // Integration
  pmsType        String?
  pmsConnected   Boolean @default(false)
  channelManager String?

  // Metadata - JSON
  amenities String?
  images    String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([gdsCode])
  @@index([city, state])
  @@index([certified])
}

model HotelMetrics {
  id      String @id @default(cuid())
  hotelId String
  hotel   Hotel  @relation(fields: [hotelId], references: [id], onDelete: Cascade)

  // Period
  period    MetricPeriod
  startDate DateTime
  endDate   DateTime

  // Occupancy
  occupancyRate  Float
  roomsOccupied  Int
  roomsAvailable Int

  // Revenue
  roomRevenue  Float
  rideRevenue  Float
  totalRevenue Float

  // Rides
  totalRides       Int
  completedRides   Int
  cancelledRides   Int
  averageRideValue Float

  // Bookings
  totalBookings    Int
  directBookings   Int
  otaBookings      Int
  averageStayDays  Float
  cancellationRate Float

  // Ratings
  guestRating Float?
  rideRating  Float?

  calculatedAt DateTime @default(now())

  @@unique([hotelId, period, startDate])
  @@index([hotelId])
}

// ============================================================================
// BOOKING MODELS
// ============================================================================

model Booking {
  id                 String @id @default(cuid())
  confirmationNumber String @unique

  // Hotel
  hotelId String
  hotel   Hotel  @relation(fields: [hotelId], references: [id])

  // Guest
  guestId String
  guest   Guest  @relation(fields: [guestId], references: [id])

  // Dates
  checkIn  DateTime
  checkOut DateTime
  nights   Int

  // Room
  roomType   String
  roomNumber String?
  roomRate   Float

  // Source & Status
  source BookingSource
  status BookingStatus

  // Financial
  roomCharges Float
  taxes       Float
  fees        Float
  totalAmount Float
  currency    String @default("USD")

  // Transportation
  airportPickup  Boolean @default(false)
  airportDropoff Boolean @default(false)
  ridesIncluded  Int     @default(0)
  ridesUsed      Int     @default(0)

  // Relationships
  rides Ride[]

  // Management
  canModify Boolean @default(true)
  canCancel Boolean @default(true)
  notes     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([hotelId])
  @@index([guestId])
  @@index([confirmationNumber])
  @@index([status])
}

model Guest {
  id        String  @id @default(cuid())
  firstName String
  lastName  String
  email     String?
  phone     String?
  country   String?

  // Preferences (JSON)
  preferences String?

  // History
  totalStays Int       @default(0)
  totalSpent Float     @default(0)
  lastStay   DateTime?

  // Relationships
  bookings Booking[]
  rides    Ride[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
}

// ============================================================================
// RIDE MODELS
// ============================================================================

model Ride {
  id String @id @default(cuid())

  // Associations
  hotelId   String
  hotel     Hotel    @relation(fields: [hotelId], references: [id])
  bookingId String?
  booking   Booking? @relation(fields: [bookingId], references: [id])
  guestId   String?
  guest     Guest?   @relation(fields: [guestId], references: [id])
  driverId  String?
  driver    Driver?  @relation(fields: [driverId], references: [id])

  // Locations
  pickupAddress String
  pickupLat     Float?
  pickupLng     Float?
  pickupTime    DateTime
  pickupType    String

  dropoffAddress String
  dropoffLat     Float?
  dropoffLng     Float?
  dropoffTime    DateTime?
  dropoffType    String

  // Status
  status  RideStatus
  isGhost Boolean    @default(false)

  // Pricing
  basePrice       Float
  distancePrice   Float
  timePrice       Float
  surgeMultiplier Float  @default(1.0)
  totalPrice      Float
  currency        String @default("USD")

  // Commission
  hotelCommission Float
  driverEarnings  Float
  platformFee     Float @default(0)

  // Tracking
  trackingUrl String?
  distance    Float?
  duration    Int?

  // Ghost ride data (for FOMO)
  ghostData String?

  requestedAt DateTime  @default(now())
  completedAt DateTime?

  @@index([hotelId])
  @@index([status])
  @@index([isGhost])
}

model Driver {
  id    String  @id @default(cuid())
  name  String
  email String  @unique
  phone String
  photo String?

  // Ratings
  rating     Float @default(5.0)
  totalTrips Int   @default(0)

  // Vehicle
  vehicleMake  String
  vehicleModel String
  vehicleYear  Int
  vehicleColor String
  vehiclePlate String
  vehicleType  String

  // Status
  available Boolean @default(true)
  verified  Boolean @default(false)
  active    Boolean @default(true)

  // Location
  lastLat    Float?
  lastLng    Float?
  lastUpdate DateTime?

  // Relationships
  rides Ride[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
  @@index([available])
}

// ============================================================================
// CAR RENTAL MODELS - WITH COMPLETE HOST LIFECYCLE MANAGEMENT
// ============================================================================

model RentalHost {
  id     String  @id @default(cuid())
  userId String? @unique

  // Dual-Role Account Linking (NEW)
  // Copy of User.legacyDualId for faster queries when checking linked accounts
  legacyDualId String?

  email        String  @unique
  name         String
  phone        String
  profilePhoto String?
  bio          String?

  // Verification
  isVerified        Boolean   @default(false)
  verifiedAt        DateTime?
  verificationLevel String?

  // Performance metrics
  responseTime   Int?
  responseRate   Float?
  acceptanceRate Float?
  totalTrips     Int    @default(0)
  rating         Float  @default(5.0)

  // Location
  city    String
  state   String
  zipCode String?

  // Status
  active   Boolean  @default(true)
  joinedAt DateTime @default(now())

  // ===== HOST MANAGEMENT FIELDS =====

  // Access control
  hostType        String  @default("PENDING")
  approvalStatus  String  @default("PENDING")
  dashboardAccess Boolean @default(false)

  // Graduated permissions
  canViewBookings  Boolean @default(false)
  canEditCalendar  Boolean @default(false)
  canSetPricing    Boolean @default(false)
  canMessageGuests Boolean @default(false)
  canWithdrawFunds Boolean @default(false)

  // Control boundaries
  minDailyRate   Float?
  maxDailyRate   Float?
  commissionRate Float  @default(0.25)

  // Approval tracking
  approvedBy          String?
  approvedAt          DateTime?
  rejectedReason      String?
  suspendedAt         DateTime?
  suspendedReason     String?
  suspensionExpiresAt DateTime?

  // Document uploads (URLs to Cloudinary)
  governmentIdUrl   String?
  driversLicenseUrl String?
  insuranceDocUrl   String?
  documentsVerified Boolean @default(false)

  // Multi-page Photo ID uploads (NEW)
  photoIdType        String?   // 'GOVERNMENT_ID' | 'DRIVERS_LICENSE' | 'PASSPORT'
  photoIdUrls        Json?     // { front: url, back: url, info?: url, lastPage?: url }
  photoIdVerified    Boolean   @default(false)
  photoIdSubmittedAt DateTime? // When user clicked "Submit" - null means not yet submitted

  // Additional host settings
  autoApproveBookings Boolean @default(true)
  requireDeposit      Boolean @default(true)
  depositAmount       Float   @default(500)

  // ===== NEW LIFECYCLE TRACKING FIELDS =====

  // Document status tracking
  documentStatuses      Json?
  pendingActions        String[] @default([])
  backgroundCheckStatus String?
  restrictionReasons    String[] @default([])

  // Notification tracking
  lastNotificationSent   DateTime?
  documentsRequestedAt   DateTime?
  documentsResubmittedAt DateTime?

  // ===== OLD FIELDS FROM DATABASE (KEEP FOR COMPATIBILITY) =====

  bankAccountInfo     String?
  defaultPayoutMethod String?
  payoutFrequency     String? @default("weekly")
  protectionPlan      String? @default("BASIC")
  protectionPlanFee   Float?
  stripeAccountId     String?
  totalPayoutAmount   Float?  @default(0)
  totalPayoutCount    Int?    @default(0)

  // ===== STRIPE CONNECT & PAYOUT FIELDS =====

  // Stripe Connect Account (FOR RECEIVING PAYOUTS)
  stripeConnectAccountId  String?   @unique
  stripeAccountStatus     String?   @default("pending")
  stripePayoutsEnabled    Boolean   @default(false)
  stripeChargesEnabled    Boolean   @default(false)
  stripeDetailsSubmitted  Boolean   @default(false)
  stripeRequirements      Json?     // Stores currently_due requirements from Stripe
  stripeDisabledReason    String?   // e.g. "requirements.past_due"
  stripeOnboardingLink    String?
  stripeTosAcceptanceDate DateTime?
  stripeTosAcceptanceIp   String?

  // ===== NEW DUAL STRIPE FIELDS - FOR CHARGING HOSTS =====

  // Stripe Customer Account (FOR CHARGING HOSTS)
  stripeCustomerId           String? @unique
  defaultPaymentMethodOnFile String?

  // Subscription Management (Fleet Manager tier)
  subscriptionTier           String    @default("FREE")
  subscriptionStatus         String    @default("ACTIVE")
  subscriptionStartDate      DateTime?
  subscriptionEndDate        DateTime?
  monthlySubscriptionFee     Float     @default(0)
  lastSubscriptionChargeDate DateTime?
  nextSubscriptionChargeDate DateTime?

  // Balance Holds & Negative Balances
  holdBalance     Float @default(0)
  negativeBalance Float @default(0)

  // Platform Charging History
  totalChargedAmount Float     @default(0)
  lastChargedDate    DateTime?
  lastChargeReason   String?

  // ===== END NEW DUAL STRIPE FIELDS =====

  // Bank Account Information (Tokenized via Stripe)
  bankAccountLast4 String?
  bankAccountName  String?
  bankName         String?
  bankAccountType  String?   @default("checking")
  bankAccountToken String?
  bankVerified     Boolean   @default(false)
  bankVerifiedDate DateTime?

  // Debit Card Information (for instant payouts via Stripe)
  debitCardLast4    String?
  debitCardBrand    String?
  debitCardExpMonth Int?
  debitCardExpYear  Int?
  debitCardToken    String?
  debitCardVerified Boolean @default(false)

  // Payout Method Management
  payoutMethods         Json?
  defaultPayoutMethodId String?

  // Payout Settings
  payoutSchedule       String  @default("weekly")
  payoutScheduleDay    String? @default("Friday")
  minimumPayoutAmount  Float   @default(50.00)
  instantPayoutEnabled Boolean @default(false)

  // Tax Information (Encrypted)
  taxIdProvided   Boolean   @default(false)
  taxIdType       String?
  businessName    String?
  businessType    String?
  w9Submitted     Boolean   @default(false)
  w9SubmittedDate DateTime?

  // Payout History & Balance
  currentBalance      Float     @default(0)
  pendingBalance      Float     @default(0)
  totalEarnings       Float     @default(0)
  lastPayoutDate      DateTime?
  lastPayoutAmount    Float?
  nextScheduledPayout DateTime?
  totalPayoutsCount   Int       @default(0)
  totalPayoutsAmount  Float     @default(0)

  // Payout Restrictions & Holds
  payoutsEnabled        Boolean   @default(false)
  payoutsDisabledReason String?
  holdFundsUntil        DateTime?
  holdReason            String?

  // Fee Structure
  platformFeeRate      Float @default(0.25)
  instantPayoutFeeRate Float @default(0.015)

  // ===== END OF PAYOUT FIELDS =====

  // ===== INSURANCE FIELDS =====

  // Platform Insurance Assignment (provider-agnostic)
  insuranceProviderId   String?
  insuranceProvider     InsuranceProvider? @relation("HostInsurance", fields: [insuranceProviderId], references: [id])
  insurancePolicyNumber String?
  insuranceActive       Boolean            @default(false)
  insuranceAssignedAt   DateTime?
  insuranceAssignedBy   String?

  // Host's Own Insurance (LEGACY - Deprecated, use new tier fields)
  hostInsuranceProvider      String?
  hostPolicyNumber           String?
  hostInsuranceExpires       DateTime?
  hostInsuranceStatus        HostInsuranceStatus @default(ACTIVE)
  hostInsuranceDeactivatedAt DateTime?
  deactivationReason         String?             @db.Text

  // Insurance History & Audit Trail
  insuranceHistory Json?

  // ===== END INSURANCE FIELDS =====

  // ===== NEW TIERED INSURANCE & EARNINGS FIELDS =====

  // Migration tracking
  usingLegacyInsurance Boolean @default(true)

  // P2P Insurance (Tier 2 - Standard: 75% earnings)
  p2pInsuranceStatus   InsuranceStatus?
  p2pInsuranceProvider String?
  p2pPolicyNumber      String?
  p2pInsuranceExpires  DateTime?
  p2pInsuranceActive   Boolean          @default(false)

  // Commercial Insurance (Tier 3 - Premium: 90% earnings)
  commercialInsuranceStatus   InsuranceStatus?
  commercialInsuranceProvider String?
  commercialPolicyNumber      String?
  commercialInsuranceExpires  DateTime?
  commercialInsuranceActive   Boolean          @default(false)

  // Active Earnings Tier (determines platform fee)
  earningsTier EarningsTier @default(BASIC)

  // ===== PHASE 2A: NEW INSURANCE TYPE & REVENUE SPLIT FIELDS =====
  insuranceType String @default("none") // "none" | "p2p" | "commercial"
  revenueSplit  Int    @default(40) // 40, 75, 90

  // Tier Change Tracking
  lastTierChange   DateTime?
  tierChangeReason String?
  tierChangeBy     String?

  // ===== END TIERED INSURANCE & EARNINGS FIELDS =====

  // ===== FLEET PARTNER FIELDS (B2B SaaS) =====

  // Partner Identity
  partnerCompanyName    String?
  partnerSlug           String?   @unique  // URL-friendly: "drive-it-pro"
  partnerLogo           String?
  partnerBio            String?   @db.Text
  partnerSupportEmail   String?
  partnerSupportPhone   String?

  // Partner Social Media & Website
  partnerWebsite        String?
  partnerInstagram      String?
  partnerFacebook       String?
  partnerTwitter        String?
  partnerLinkedIn       String?
  partnerTikTok         String?
  partnerYouTube        String?

  // Partner Contact Visibility Settings
  partnerShowEmail      Boolean   @default(true)
  partnerShowPhone      Boolean   @default(true)
  partnerShowWebsite    Boolean   @default(true)

  // Tiered Commission System (set by Fleet)
  tier1VehicleCount     Int       @default(10)    // 10+ cars → 20%
  tier1CommissionRate   Float     @default(0.20)
  tier2VehicleCount     Int       @default(50)    // 50+ cars → 15%
  tier2CommissionRate   Float     @default(0.15)
  tier3VehicleCount     Int       @default(100)   // 100+ cars → 10%
  tier3CommissionRate   Float     @default(0.10)
  currentCommissionRate Float     @default(0.25)  // Calculated based on fleet size

  // Partner Privileges
  autoApproveListings   Boolean   @default(true)   // Pre-approved vehicle listings

  // Partner Stats (denormalized for performance)
  partnerFleetSize      Int       @default(0)
  partnerTotalBookings  Int       @default(0)
  partnerTotalRevenue   Float     @default(0)
  partnerAvgRating      Float     @default(0)

  // Partner Payout Schedule
  partnerPayoutSchedule PartnerPayoutSchedule?

  // Partner Page Customization
  partnerHeroImage      String?               // Cloudinary URL for hero background (1920x400)
  partnerHeroTitle      String?               // Main headline on landing page
  partnerHeroSubtitle   String?               // Subheadline on landing page
  partnerPrimaryColor   String?               // Hex color for branding (e.g. #f97316)
  partnerBadges         Json?                 // Array of badge objects: [{name, imageUrl}]
  partnerBenefits       Json?                 // Array of benefits: [{icon, title, description}]
  partnerPolicies       Json?                 // {refundPolicy, cancellationPolicy, bookingRequirements}
  businessHours         String?               // e.g. "Mon-Sun 8am-8pm"
  yearEstablished       Int?                  // Year company was founded

  // ===== END FLEET PARTNER FIELDS =====

  // ===== FLEET MANAGER & VEHICLE OWNER FIELDS =====

  isHostManager         Boolean   @default(false)    // Can manage other owners' vehicles
  isVehicleOwner        Boolean   @default(false)    // Has vehicles managed by others
  hostManagerSlug       String?   @unique            // Public URL: /fleet/[slug]
  hostManagerName       String?                       // Display name for fleet manager profile
  hostManagerBio        String?   @db.Text           // Bio for public profile
  hostManagerLogo       String?                       // Logo URL
  managesOwnCars        Boolean   @default(true)     // Managing their own vehicles
  managesOthersCars     Boolean   @default(false)    // Managing other owners' vehicles

  // ===== END FLEET MANAGER FIELDS =====

  // Relations
  user                  User?                @relation(fields: [userId], references: [id])
  cars                  RentalCar[]
  bookings              RentalBooking[]
  reviews               RentalReview[]
  payouts               RentalPayout[]
  hostPayouts           HostPayout[]
  backgroundChecks      BackgroundCheck[]
  hostNotifications     HostNotification[]
  documentStatusRecords HostDocumentStatus[]
  paymentMethods        PaymentMethod[]      @relation("HostPaymentMethods")
  hostCharges           HostCharge[]
  claims                Claim[]
  esgProfile            HostESGProfile?      @relation("HostESGProfile")

  // Fleet Partner Relations
  partnerApplication       PartnerApplication?
  partnerDocuments         PartnerDocument[]
  partnerDiscounts         PartnerDiscount[]
  partnerPayouts           PartnerPayout[]
  partnerCommissionHistory PartnerCommissionHistory[]
  partnerFaqs              PartnerFAQ[]

  // Fleet Manager Relations
  managedVehicles          VehicleManagement[] @relation("ManagerVehicles")
  ownedManagedVehicles     VehicleManagement[] @relation("OwnerVehicles")
  sentInvitations          ManagementInvitation[] @relation("InvitationSender")
  receivedInvitations      ManagementInvitation[] @relation("InvitationRecipient")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
  @@index([city, state])
  @@index([hostType])
  @@index([approvalStatus])
  @@index([stripeConnectAccountId])
  @@index([stripeCustomerId])
  @@index([payoutsEnabled])
  @@index([stripeAccountId])
  @@index([hostInsuranceStatus])
  @@index([insuranceProviderId])
  @@index([earningsTier])
  @@index([p2pInsuranceStatus])
  @@index([commercialInsuranceStatus])
  @@index([usingLegacyInsurance])
  @@index([legacyDualId])
  @@index([partnerSlug])
  @@index([hostManagerSlug])
  @@index([isHostManager])
  @@index([isVehicleOwner])
}

// ============================================================================
// FLEET PARTNER APPLICATION (B2B SaaS)
// ============================================================================

model PartnerApplication {
  id     String     @id @default(cuid())
  hostId String     @unique
  host   RentalHost @relation(fields: [hostId], references: [id], onDelete: Cascade)

  // Company Info
  companyName     String
  businessType    String   // LLC, Corporation, Sole Proprietor
  yearsInBusiness Int

  // Contact
  contactName  String
  contactEmail String
  contactPhone String

  // Fleet Details
  fleetSize       Int
  vehicleTypes    String[] // SUV, Sedan, Luxury, etc.
  operatingCities String[]

  // Application Workflow
  currentStep Int                      @default(1)
  status      PartnerApplicationStatus @default(DRAFT)
  submittedAt DateTime?
  reviewedAt  DateTime?
  reviewedBy  String?
  reviewNotes String?                  @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([submittedAt])
  @@map("partner_applications")
}

// ============================================================================
// PARTNER DOCUMENT (Document Expiry Tracking - PRO Feature)
// ============================================================================

model PartnerDocument {
  id     String     @id @default(cuid())
  hostId String
  host   RentalHost @relation(fields: [hostId], references: [id], onDelete: Cascade)

  type PartnerDocumentType
  url  String

  // EXPIRY TRACKING (Critical for compliance)
  uploadedAt        DateTime               @default(now())
  expiresAt         DateTime?
  isExpired         Boolean                @default(false)
  gracePeriodEndsAt DateTime? // 72 hours after expiry before auto-suspend

  // Review Status
  status     PartnerDocumentStatus @default(PENDING)
  reviewedBy String?
  reviewedAt DateTime?
  rejectNote String?               @db.Text

  // Reminder tracking
  reminderSentAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([hostId, type])
  @@index([expiresAt])
  @@index([isExpired])
  @@index([gracePeriodEndsAt])
  @@map("partner_documents")
}

// ============================================================================
// PARTNER DISCOUNT (Promo codes for partner fleets)
// ============================================================================

model PartnerDiscount {
  id     String     @id @default(cuid())
  hostId String
  host   RentalHost @relation(fields: [hostId], references: [id], onDelete: Cascade)

  code        String  @unique
  title       String
  description String? @db.Text
  percentage  Float // 0.10 = 10% off
  maxUses     Int?
  usedCount   Int     @default(0)

  startsAt  DateTime?
  expiresAt DateTime?
  isActive  Boolean   @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([hostId])
  @@index([code])
  @@index([isActive])
  @@map("partner_discounts")
}

// ============================================================================
// PARTNER PAYOUT (Revenue payouts to partners)
// ============================================================================

model PartnerPayout {
  id     String     @id @default(cuid())
  hostId String
  host   RentalHost @relation(fields: [hostId], references: [id], onDelete: Cascade)

  period       String // "2025-01" for monthly, "2025-W03" for weekly
  bookingCount Int
  grossRevenue Float
  commission   Float // Platform's cut
  netAmount    Float // What partner receives

  stripePayoutId   String?
  stripeTransferId String?
  status           PartnerPayoutStatus @default(PENDING)
  paidAt           DateTime?
  failureReason    String?             @db.Text

  createdAt DateTime @default(now())

  @@index([hostId])
  @@index([period])
  @@index([status])
  @@map("partner_payouts")
}

// ============================================================================
// PARTNER COMMISSION HISTORY (Audit trail for commission changes)
// ============================================================================

model PartnerCommissionHistory {
  id     String     @id @default(cuid())
  hostId String
  host   RentalHost @relation(fields: [hostId], references: [id], onDelete: Cascade)

  oldRate   Float // 0.25 = 25%
  newRate   Float // 0.20 = 20%
  reason    String? @db.Text // "Volume discount tier reached"
  changedBy String // Fleet admin ID or "SYSTEM"

  createdAt DateTime @default(now())

  @@index([hostId])
  @@index([createdAt])
  @@map("partner_commission_history")
}

// ============================================================================
// PARTNER FAQ (Partner-specific FAQs for landing pages)
// ============================================================================

model PartnerFAQ {
  id     String     @id @default(cuid())
  hostId String
  host   RentalHost @relation(fields: [hostId], references: [id], onDelete: Cascade)

  question String
  answer   String @db.Text
  order    Int    @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([hostId])
  @@map("partner_faqs")
}

// ============================================================================
// FLEET MANAGER & VEHICLE OWNER MODELS
// ============================================================================

model VehicleManagement {
  id                    String   @id @default(cuid())

  // Core relationships
  vehicleId             String   @unique
  vehicle               RentalCar @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  ownerId               String
  owner                 RentalHost @relation("OwnerVehicles", fields: [ownerId], references: [id])

  managerId             String
  manager               RentalHost @relation("ManagerVehicles", fields: [managerId], references: [id])

  // Commission split (percentages of the 90% after platform cut)
  ownerCommissionPercent   Decimal  @default(70) @db.Decimal(5,2)
  managerCommissionPercent Decimal  @default(30) @db.Decimal(5,2)

  // Management permissions
  canEditListing        Boolean  @default(true)
  canAdjustPricing      Boolean  @default(true)
  canCommunicateGuests  Boolean  @default(true)
  canApproveBookings    Boolean  @default(true)
  canHandleIssues       Boolean  @default(true)

  // Status
  status                VehicleManagementStatus @default(ACTIVE)

  // Agreement details
  agreementNotes        String?  @db.Text
  agreementSignedAt     DateTime?

  // Audit
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([ownerId])
  @@index([managerId])
  @@index([status])
  @@map("vehicle_management")
}

model ManagementInvitation {
  id                    String   @id @default(cuid())

  // Invitation token (for email link)
  token                 String   @unique @default(cuid())

  // Type of invitation
  type                  ManagementInvitationType

  // Who sent the invitation
  senderId              String
  sender                RentalHost @relation("InvitationSender", fields: [senderId], references: [id])

  // Who receives the invitation (optional - may not have account yet)
  recipientId           String?
  recipient             RentalHost? @relation("InvitationRecipient", fields: [recipientId], references: [id])
  recipientEmail        String

  // For OWNER_INVITES_MANAGER: which vehicle(s) to manage
  vehicleIds            String[]

  // Proposed commission split
  proposedOwnerPercent  Decimal  @default(70) @db.Decimal(5,2)
  proposedManagerPercent Decimal @default(30) @db.Decimal(5,2)

  // Negotiation
  counterOfferOwnerPercent   Decimal? @db.Decimal(5,2)
  counterOfferManagerPercent Decimal? @db.Decimal(5,2)
  negotiationRounds     Int      @default(0)
  negotiationNotes      String?  @db.Text
  negotiationHistory    Json?    @default("[]")

  // Proposed permissions
  proposedCanEditListing       Boolean @default(true)
  proposedCanAdjustPricing     Boolean @default(true)
  proposedCanCommunicateGuests Boolean @default(true)
  proposedCanApproveBookings   Boolean @default(true)
  proposedCanHandleIssues      Boolean @default(true)

  // Status tracking
  status                ManagementInvitationStatus @default(PENDING)

  // Timestamps
  expiresAt             DateTime
  respondedAt           DateTime?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([token])
  @@index([senderId])
  @@index([recipientId])
  @@index([recipientEmail])
  @@index([status])
  @@map("management_invitations")
}

// ============================================================================
// ADMIN IMPERSONATION LOG (Audit trail for admin shadow login - PRO Feature)
// ============================================================================

model AdminImpersonationLog {
  id String @id @default(cuid())

  adminId   String
  partnerId String

  reason   String
  duration Int? // Seconds of session

  ipAddress String?
  userAgent String?

  createdAt DateTime  @default(now())
  endedAt   DateTime?

  @@index([adminId])
  @@index([partnerId])
  @@index([createdAt])
  @@map("admin_impersonation_logs")
}

// ============================================================================
// HOST CHARGE MODEL (NEW - TRACK PLATFORM CHARGING HOSTS)
// ============================================================================

model HostCharge {
  id     String     @id @default(cuid())
  hostId String
  host   RentalHost @relation(fields: [hostId], references: [id], onDelete: Cascade)

  // Charge details
  amount     Float
  chargeType String
  reason     String @db.Text

  // Admin tracking
  chargedBy        String
  stripeChargeId   String?
  stripeCustomerId String?

  // Status tracking
  status        String
  failureReason String? @db.Text

  // Payment method used
  paymentMethodUsed String?

  // Metadata
  metadata Json?
  notes    String? @db.Text

  // Related entities
  relatedBookingId String?
  relatedClaimId   String?

  createdAt   DateTime  @default(now())
  processedAt DateTime?
  refundedAt  DateTime?

  @@index([hostId])
  @@index([status])
  @@index([chargeType])
  @@index([createdAt])
  @@map("host_charges")
}

// ============================================================================
// PAYMENT METHOD MODEL (UPDATED WITH CARD FIELDS)
// ============================================================================

model PaymentMethod {
  id     String      @id @default(cuid())
  hostId String?
  host   RentalHost? @relation("HostPaymentMethods", fields: [hostId], references: [id], onDelete: Cascade)

  // User relation for guest payment methods
  userId String?
  user   User?   @relation("UserPaymentMethods", fields: [userId], references: [id], onDelete: Cascade)

  // Method details
  type           String
  stripeMethodId String @unique

  // Display information
  last4       String
  brand       String?
  accountType String?

  // Card-specific fields
  expiryMonth Int?
  expiryYear  Int?
  holderName  String?

  // Status
  status     String?   @default("active")
  isDefault  Boolean   @default(false)
  isVerified Boolean   @default(false)
  verifiedAt DateTime?

  // Metadata
  nickname String?
  metadata Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([hostId])
  @@index([userId])
  @@index([stripeMethodId])
  @@index([isDefault])
}

// ============================================================================
// NEW HOST LIFECYCLE MODELS FOR PHASE 1
// ============================================================================

model BackgroundCheck {
  id     String     @id @default(cuid())
  hostId String
  host   RentalHost @relation(fields: [hostId], references: [id])

  // Check types and statuses
  checkType String
  status    BackgroundCheckStatus @default(PENDING)
  provider  String?

  // Request tracking
  requestedAt DateTime  @default(now())
  completedAt DateTime?
  expiresAt   DateTime?

  // Results
  passed    Boolean?
  score     Int?
  details   Json?
  reportUrl String?

  // Failure/Issue tracking
  failureReason String?
  issues        Json?

  // Manual override
  manuallyReviewed Boolean   @default(false)
  reviewedBy       String?
  reviewedAt       DateTime?
  overrideReason   String?

  // Retry tracking
  retryCount  Int       @default(0)
  nextRetryAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([hostId, checkType])
  @@index([hostId])
  @@index([status])
  @@index([checkType])
  @@index([expiresAt])
}

model HostNotification {
  id     String     @id @default(cuid())
  hostId String
  host   RentalHost @relation(fields: [hostId], references: [id])

  // Notification details
  type     String
  category String
  subject  String
  message  String @db.Text

  // Status tracking
  status      NotificationStatus @default(PENDING)
  sentAt      DateTime?
  readAt      DateTime?
  respondedAt DateTime?

  // Delivery tracking
  emailSent  Boolean @default(false)
  smsSent    Boolean @default(false)
  pushSent   Boolean @default(false)
  inAppShown Boolean @default(false)

  // Response tracking
  responseRequired Boolean   @default(false)
  responseDeadline DateTime?
  responseReceived String?

  // Action tracking
  actionRequired  String?
  actionUrl       String?
  actionLabel     String?
  actionCompleted Boolean @default(false)

  // Related entities
  relatedDocumentType String?
  relatedCheckType    String?

  // Retry/Reminder tracking
  reminderCount  Int       @default(0)
  lastReminderAt DateTime?
  nextReminderAt DateTime?

  // Priority
  priority String @default("normal")

  // Expiry
  expiresAt DateTime?

  // Metadata
  metadata  Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([hostId])
  @@index([type])
  @@index([status])
  @@index([priority])
  @@index([responseDeadline])
}

model HostDocumentStatus {
  id     String     @id @default(cuid())
  hostId String
  host   RentalHost @relation(fields: [hostId], references: [id])

  // Document identification
  documentType String
  documentUrl  String?

  // Status tracking
  status     DocumentStatus @default(NOT_UPLOADED)
  uploadedAt DateTime?

  // Review tracking
  reviewStatus DocumentReviewStatus @default(PENDING)
  reviewedBy   String?
  reviewedAt   DateTime?

  // Quality checks
  isReadable Boolean?
  isExpired  Boolean?
  expiryDate DateTime?

  // Verification details
  verificationMethod String?
  verificationScore  Int?

  // Issues and feedback
  issues          Json?
  feedback        String?
  rejectionReason String?

  // Request tracking
  requestedAt    DateTime?
  remindersSent  Int       @default(0)
  lastReminderAt DateTime?

  // Resubmission tracking
  resubmissionCount Int       @default(0)
  lastResubmittedAt DateTime?

  // Auto-expiry handling
  expiryWarningAt DateTime?
  autoSuspendAt   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([hostId, documentType])
  @@index([hostId])
  @@index([status])
  @@index([reviewStatus])
  @@index([expiryDate])
}

// ============================================================================
// INSURANCE PROVIDER MODEL (UPDATED WITH VEHICLE RULES)
// ============================================================================

model InsuranceProvider {
  id   String                @id @default(cuid())
  name String
  type InsuranceProviderType

  // Status
  isActive  Boolean @default(true)
  isPrimary Boolean @default(false)

  // Coverage Configuration (JSON)
  coverageTiers Json
  pricingRules  Json

  // ===== NEW: VEHICLE-BASED COVERAGE RULES =====
  vehicleRules Json? // Stores complex vehicle eligibility rules

  // API Integration (for providers like Tint)
  apiKey                 String? @db.Text
  apiEndpoint            String?
  webhookUrl             String?
  apiEndpointPlaceholder String?

  // Business Terms
  revenueShare Float @default(0.30)

  // Contract Details
  contractStart     DateTime?
  contractEnd       DateTime?
  contractTerms     String?   @db.Text
  contractStartDate DateTime?
  contractEndDate   DateTime?

  // Vehicle Restrictions
  vehicleValueMin Float?
  vehicleValueMax Float?
  excludedMakes   String[] @default([])
  excludedModels  String[] @default([])

  // Provider Details
  coverageNotes String? @db.Text
  contactEmail  String?
  contactPhone  String?

  // Relations
  assignedHosts          RentalHost[]               @relation("HostInsurance")
  policies               InsurancePolicy[]
  rateHistory            InsuranceRateHistory[]
  vehicleOverrides       VehicleInsuranceOverride[]
  vehicleClassifications VehicleClassification[]    @relation("ProviderVehicleClassifications")
  coverageOverrides      VehicleCoverageOverride[]
  providerMessages       ProviderMessage[]
  providerDocuments      ProviderDocument[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive])
  @@index([isPrimary])
}

// ============================================================================
// PHASE 2A: NEW PROVIDER MESSAGE MODEL
// ============================================================================

model ProviderMessage {
  id         String            @id @default(cuid())
  providerId String
  provider   InsuranceProvider @relation(fields: [providerId], references: [id], onDelete: Cascade)

  subject  String
  message  String @db.Text
  category String // "general", "claim_inquiry", "policy_question", "technical"
  priority String @default("normal") // "low", "normal", "high", "urgent"

  sentBy     String
  sentByName String
  direction  String // "outbound", "inbound"

  attachments    Json?
  relatedClaimId String?

  status    String    @default("sent") // "sent", "delivered", "read", "replied"
  readAt    DateTime?
  replyToId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([providerId])
  @@index([category])
  @@index([status])
  @@index([relatedClaimId])
}

// ============================================================================
// PHASE 2A: NEW PROVIDER DOCUMENT MODEL
// ============================================================================

model ProviderDocument {
  id         String            @id @default(cuid())
  providerId String
  provider   InsuranceProvider @relation(fields: [providerId], references: [id], onDelete: Cascade)

  name              String
  category          String // "contract", "policy_template", "rate_sheet", "compliance", "w9", "certificate"
  fileUrl           String
  fileSize          Int
  fileType          String
  version           String  @default("1.0")
  previousVersionId String?
  description       String? @db.Text
  uploadedBy        String

  expiresAt    DateTime?
  reminderSent Boolean   @default(false)
  status       String    @default("active") // "active", "archived", "expired"

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([providerId])
  @@index([category])
  @@index([status])
  @@index([expiresAt])
}

// ============================================================================
// NEW: VEHICLE CLASSIFICATION MODEL - DETERMINES COVERAGE ELIGIBILITY
// ============================================================================

model VehicleClassification {
  id    String @id @default(cuid())
  make  String
  model String
  year  Int

  // Vehicle categorization
  category  VehicleCategory
  riskLevel RiskCategory

  // Value information
  baseValue      Decimal   @db.Decimal(12, 2)
  currentValue   Decimal   @db.Decimal(12, 2)
  valueSource    String? // "KBB", "NADA", "Manual", etc.
  lastValueCheck DateTime?

  // Vehicle characteristics (JSON for flexibility)
  features Json? // convertible, turbo, electric, performance, etc.

  // Insurance eligibility
  isInsurable          Boolean @default(true)
  insurabilityReason   String? @db.Text
  requiresManualReview Boolean @default(false)

  // Rate multipliers
  baseRateMultiplier Decimal @default(1.0) @db.Decimal(5, 2)
  riskMultiplier     Decimal @default(1.0) @db.Decimal(5, 2)

  // Provider-specific rules
  providerId            String?
  provider              InsuranceProvider? @relation("ProviderVehicleClassifications", fields: [providerId], references: [id])
  providerSpecificRules Json?

  // Relations to actual rental cars
  rentalCars RentalCar[] @relation("CarClassification")

  // Metadata
  notes     String? @db.Text
  createdBy String?
  updatedBy String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([make, model, year, providerId])
  @@index([make, model])
  @@index([category])
  @@index([riskLevel])
  @@index([baseValue])
  @@index([isInsurable])
  @@index([providerId])
}

// ============================================================================
// NEW: VEHICLE COVERAGE OVERRIDE MODEL - SPECIAL CASES
// ============================================================================

model VehicleCoverageOverride {
  id    String  @id @default(cuid())
  carId String
  vin   String?

  providerId String
  provider   InsuranceProvider @relation(fields: [providerId], references: [id])

  // Override details
  overrideType CoverageOverrideType
  customRules  Json // Custom eligibility/pricing rules
  reason       String               @db.Text

  // Approval tracking
  approvedBy String
  approvedAt DateTime  @default(now())
  expiresAt  DateTime?

  // Status
  isActive Boolean @default(true)

  // Relations
  car RentalCar @relation(fields: [carId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([carId, providerId])
  @@index([carId])
  @@index([providerId])
  @@index([vin])
  @@index([expiresAt])
}

// ============================================================================
// INSURANCE POLICY MODEL (UPDATED WITH NEW ROUTING FIELDS)
// ============================================================================

model InsurancePolicy {
  id         String @id @default(cuid())
  bookingId  String @unique
  providerId String

  // Coverage Tier
  tier InsuranceTier

  // Coverage Amounts
  liabilityCoverage Float @default(750000)
  collisionCoverage Float
  deductible        Float

  // Pricing
  dailyPremium    Float
  totalPremium    Float
  platformRevenue Float

  // Special Handling
  increasedDeposit Float?

  // Status
  status       PolicyStatus
  policyNumber String?

  // Policy Period
  effectiveDate DateTime
  expiryDate    DateTime

  // ===== NEW: POLICY BINDING & ROUTING =====
  policySource     String? // "liberty_api", "host_p2p", "guest_personal", "platform"
  boundViaApi      Boolean @default(false)
  externalPolicyId String? // Liberty/Tint policy ID
  primaryParty     String? // "host", "guest", "platform"
  hostTier         String? // "40%", "75%", "90%"
  policySnapshot   Json? // Complete policy details at binding time

  // Relations
  provider InsuranceProvider @relation(fields: [providerId], references: [id])
  booking  RentalBooking     @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  claims   Claim[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([bookingId])
  @@index([providerId])
  @@index([status])
}

// ============================================================================
// CLAIM MODEL - COMPLETE WITH ALL WORKFLOW FIELDS + NEW ROUTING FIELDS + INCIDENT LOCATION + FNOL
// ============================================================================

model Claim {
  id        String @id @default(cuid())
  policyId  String
  bookingId String
  hostId    String

  // Claim Type & Incident
  type               ClaimType
  reportedBy         String
  description        String    @db.Text
  incidentDate       DateTime
  damagePhotosLegacy Json? // LEGACY: Old JSON storage (optional for backward compatibility)

  // ===== INCIDENT LOCATION & CONDITIONS =====
  incidentAddress     String?
  incidentCity        String?
  incidentState       String?
  incidentZip         String?
  incidentLatitude    Float?
  incidentLongitude   Float?
  incidentDescription String? @db.Text // Additional location details
  weatherConditions   String? // "Clear", "Rain", "Snow", "Fog", etc.
  roadConditions      String? // "Dry", "Wet", "Icy", "Construction", etc.
  policeReportNumber  String?
  witnesses           Json? // Array: [{name, phone, email}]

  // ===== NEW: FNOL INCIDENT-SPECIFIC FIELDS =====

  // Odometer & Vehicle Condition
  odometerAtIncident Int? // Odometer reading at time of incident
  vehicleDrivable    Boolean @default(true) // Can vehicle be driven?
  vehicleLocation    String? // Current location if not drivable

  // Weather & Road Conditions (Enhanced)
  weatherDescription String? // Additional weather details
  roadDescription    String? // Additional road details
  estimatedSpeed     Int? // Speed at time of impact (mph)
  trafficConditions  String? // "LIGHT", "MODERATE", "HEAVY", "STOPPED"

  // Police Report (Enhanced)
  wasPoliceContacted Boolean   @default(false)
  policeDepartment   String?
  officerName        String?
  officerBadge       String?
  policeReportFiled  Boolean   @default(false)
  policeReportDate   DateTime?

  // Other Party (JSON Object - if collision)
  otherPartyInvolved Boolean @default(false)
  otherParty         Json? // {driver: {name, phone, license}, vehicle: {year, make, model, plate, vin}, insurance: {carrier, policy}}

  // Injuries (JSON Array)
  wereInjuries Boolean @default(false)
  injuries     Json? // [{person, description, severity, medicalAttention, hospital}]

  // ===== NEW: FNOL WORKFLOW FIELDS =====
  fnolStatus      String?   @default("NOT_STARTED") // "NOT_STARTED" | "PARTIAL" | "SUBMITTED" | "COMPLETE"
  fnolSubmittedAt DateTime?
  fnolSubmittedBy String?
  fnolNumber      String?   @unique

  adjusterAssigned   Boolean   @default(false)
  adjusterName       String?
  adjusterEmail      String?
  adjusterPhone      String?
  adjusterAssignedAt DateTime?

  claimOpenedAt           DateTime?
  claimSubmittedToInsurer DateTime?
  claimClosedAt           DateTime?

  // Assessment
  estimatedCost Float

  // Review Process
  status      ClaimStatus
  reviewedBy  String?
  reviewedAt  DateTime?
  reviewNotes String?     @db.Text

  // Approval & Payment
  approvedAmount Float?
  deductible     Float  @default(500)

  // Payout Tracking
  payoutId   String?
  paidToHost DateTime?
  paidAmount Float?

  // Recovery from Guest
  platformAdvanceAmount Float?
  recoveredFromGuest    Float?
  recoveryStatus        RecoveryStatus?

  // Audit Trail
  overrideHistory Json?

  // Fault Determination
  guestAtFault    Boolean @default(false)
  faultPercentage Int?

  // ===== INSURANCE ROUTING & SEVERITY =====
  primaryParty         String? // "host", "guest", "platform"
  severity             String? // "minor", "major", "total_loss", "injury"
  guestRespondedAt     DateTime?
  lockedCarState       String? // "deactivated_by_host", "deactivated_by_fleet", "active"
  submittedToInsurerAt DateTime?
  insurerClaimId       String?
  insurerStatus        String?
  insurerPaidAt        DateTime?
  insurerPaidAmount    Float?
  insurerDenialReason  String?

  // ===== GUEST RESPONSE SYSTEM =====
  guestResponseText     String?   @db.Text
  guestResponseDate     DateTime?
  guestResponseDeadline DateTime?
  guestResponsePhotos   Json?
  accountHoldApplied    Boolean   @default(false)

  // ===== GUEST-FILED CLAIMS =====
  filedByGuestId String? // If claim was filed BY the guest (against host)
  filedByRole    String? // 'HOST' | 'GUEST' | 'PARTNER' | 'FLEET'

  // ===== VEHICLE DEACTIVATION TRACKING =====
  vehicleDeactivated   Boolean   @default(false)
  vehicleReactivatedAt DateTime?
  vehicleReactivatedBy String?

  // ===== EMAIL NOTIFICATION TRACKING =====
  hostNotifiedAt   DateTime?
  guestNotifiedAt  DateTime?
  reminderSentAt   DateTime?
  escalationSentAt DateTime?

  // ===== TIMELINE/ACTIVITY TRACKING =====
  activityLog   Json? // Complete history of all actions
  statusHistory Json? // All status changes

  // ===== PHASE 5 - VEHICLE REACTIVATION WORKFLOW =====
  repairDocumentUrls  Json? // Photos of repairs
  safetyChecklistData Json? // Verification checklist
  reactivationNotes   String? @db.Text

  // ===== PHASE 7 - CLAIMS MESSAGING (FUTURE) =====
  unreadMessagesCount Int       @default(0)
  lastMessageAt       DateTime?

  // Relations
  policy       InsurancePolicy    @relation(fields: [policyId], references: [id])
  booking      RentalBooking      @relation(fields: [bookingId], references: [id])
  host         RentalHost         @relation(fields: [hostId], references: [id])
  messages     ClaimMessage[]
  edits        ClaimEdit[]
  damagePhotos ClaimDamagePhoto[] // NEW: Structured photo records

  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  resolvedAt DateTime?

  @@unique([bookingId, hostId])
  @@index([hostId])
  @@index([bookingId])
  @@index([policyId])
  @@index([status])
  @@index([type])
  @@index([payoutId])
  @@index([guestResponseDeadline])
  @@index([vehicleDeactivated])
  @@index([lastMessageAt])
  @@index([incidentCity])
  @@index([incidentState])
  @@index([policeReportNumber])
  @@index([wasPoliceContacted])
  @@index([otherPartyInvolved])
  @@index([wereInjuries])
  @@index([vehicleDrivable])
  @@index([fnolStatus])
  @@index([fnolNumber])
  @@index([filedByGuestId])
  @@index([filedByRole])

  // Relation to TripIssue (if escalated from a trip issue)
  tripIssue TripIssue?
}

// ============================================================================
// TRIP ISSUE MODEL - PRE-CLAIM DAMAGE/ISSUE TRACKING
// ============================================================================
// Captures issues detected at trip end before formal claim escalation
// Only ONE TripIssue per booking - combines host and guest reports

model TripIssue {
  id        String        @id @default(cuid())
  bookingId String        @unique // Only ONE issue per booking
  booking   RentalBooking @relation(fields: [bookingId], references: [id])

  // Host report
  hostReportedAt    DateTime?
  hostDescription   String?   @db.Text
  hostPhotos        Json? // Photo URLs from host
  hostEstimatedCost Float?

  // Guest report
  guestReportedAt  DateTime?
  guestDescription String?   @db.Text
  guestPhotos      Json? // Photo URLs from guest

  // Combined analysis
  issueType String // 'DAMAGE' | 'MILEAGE' | 'FUEL' | 'CLEANING' | 'MECHANICAL' | 'OTHER'
  severity  String // 'MINOR' | 'MODERATE' | 'MAJOR'

  // Trip capture evidence (auto-linked from booking)
  tripStartMileage Int?
  tripEndMileage   Int?
  tripStartFuel    String?
  tripEndFuel      String?
  startPhotosRef   Json? // References to InspectionPhoto IDs or URLs
  endPhotosRef     Json?

  // Resolution workflow
  // Statuses: OPEN → PENDING_GUEST_ACK → PENDING_HOST_REVIEW → RESOLVED | ESCALATED_TO_CLAIM
  status String @default("OPEN")

  guestAcknowledgedAt DateTime?
  guestAckNotes       String?   @db.Text
  hostReviewedAt      DateTime?
  hostReviewNotes     String?   @db.Text

  resolvedAt DateTime?
  resolvedBy String? // 'HOST' | 'GUEST' | 'ADMIN' | 'SYSTEM'
  resolution String? @db.Text

  // Link to claim if escalated
  claimId String? @unique
  claim   Claim?  @relation(fields: [claimId], references: [id])

  // Auto-escalation tracking
  escalationDeadline DateTime? // 48 hours after creation
  autoEscalated      Boolean   @default(false)

  // Notifications
  hostNotifiedAt  DateTime?
  guestNotifiedAt DateTime?
  reminderSentAt  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([issueType])
  @@index([escalationDeadline])
}

// ============================================================================
// CLAIM MESSAGE MODEL - IN-CLAIM COMMUNICATION
// ============================================================================

model ClaimMessage {
  id      String @id @default(cuid())
  claimId String
  claim   Claim  @relation(fields: [claimId], references: [id], onDelete: Cascade)

  // Sender Information
  senderId   String
  senderType String // "HOST", "GUEST", "FLEET_ADMIN"
  senderName String?

  // Message Content
  message     String @db.Text
  attachments Json? // Array of file URLs

  // Read Tracking
  readBy Json? // Array of user IDs who read it
  isRead Boolean @default(false)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([claimId])
  @@index([createdAt])
  @@index([senderType])
}

// ============================================================================
// CLAIM EDIT TRACKING MODEL - AUDIT TRAIL FOR CLAIM MODIFICATIONS
// ============================================================================

model ClaimEdit {
  id      String @id @default(cuid())
  claimId String
  claim   Claim  @relation(fields: [claimId], references: [id], onDelete: Cascade)

  fieldChanged String // "description", "photos", "estimatedCost", etc.
  oldValue     String? @db.Text
  newValue     String? @db.Text

  editedAt     DateTime @default(now())
  editedBy     String // hostId or adminId
  editedByType String // "HOST" or "ADMIN"
  reason       String?  @db.Text // Optional: why they edited

  createdAt DateTime @default(now())

  @@index([claimId])
  @@index([editedBy])
  @@index([editedAt])
  @@index([fieldChanged])
}

// ============================================================================
// CLAIM DAMAGE PHOTO MODEL - SEPARATE PHOTO MANAGEMENT
// ============================================================================

model ClaimDamagePhoto {
  id      String @id @default(cuid())
  claimId String
  claim   Claim  @relation(fields: [claimId], references: [id], onDelete: Cascade)

  url     String
  caption String?
  order   Int     @default(0)

  uploadedBy String // "HOST" or "GUEST"
  uploadedAt DateTime @default(now())

  deletedAt DateTime?
  deletedBy String?

  createdAt DateTime @default(now())

  @@index([claimId])
  @@index([uploadedBy])
  @@index([uploadedAt])
  @@index([deletedAt])
}

// ============================================================================
// INSURANCE RATE HISTORY MODEL
// ============================================================================

model InsuranceRateHistory {
  id            String   @id @default(cuid())
  providerId    String
  tier          String
  vehicleClass  String
  oldRate       Float
  newRate       Float
  change        Float
  changePercent Float?
  changeType    String
  effectiveDate DateTime
  changedBy     String
  reason        String?

  provider InsuranceProvider @relation(fields: [providerId], references: [id])

  createdAt DateTime @default(now())

  @@index([providerId])
  @@index([effectiveDate])
  @@index([tier])
  @@index([vehicleClass])
}

// ============================================================================
// VEHICLE INSURANCE OVERRIDE MODEL (EXISTING - KEPT FOR COMPATIBILITY)
// ============================================================================

model VehicleInsuranceOverride {
  id           String @id @default(cuid())
  carId        String
  providerId   String
  reason       String
  overriddenBy String

  car      RentalCar         @relation(fields: [carId], references: [id])
  provider InsuranceProvider @relation(fields: [providerId], references: [id])

  createdAt DateTime @default(now())

  @@unique([carId, providerId])
  @@index([carId])
  @@index([providerId])
}

// ============================================================================
// INSURANCE NOTIFICATION MODEL
// ============================================================================

model InsuranceNotification {
  id      String   @id @default(cuid())
  type    String
  sentTo  String[]
  subject String
  message String   @db.Text
  sentBy  String

  sentAt DateTime @default(now())

  @@index([type])
  @@index([sentAt])
}

// ============================================================================
// RENTAL CAR MODELS (UPDATED WITH CLAIM LOCKING FIELDS + LIENHOLDER ADDRESS + NEW DOCUMENT VERIFICATION)
// ============================================================================

model RentalCar {
  id         String  @id @default(cuid())
  hostId     String
  source     String  @default("p2p")
  externalId String?

  // Car Details
  make         String
  model        String
  year         Int
  trim         String?
  color        String
  licensePlate String? // ✅ OPTIONAL - Will backfill
  vin          String? // ✅ OPTIONAL - Will backfill
  description  String? @db.Text // Vehicle description for listings

  // ===== NEW: VEHICLE CLASSIFICATION LINK =====
  classificationId String?
  classification   VehicleClassification? @relation("CarClassification", fields: [classificationId], references: [id])

  // ===== NEW: INSURANCE ELIGIBILITY FIELDS =====
  insuranceEligible          Boolean  @default(true)
  insuranceCategory          String? // Cached from classification
  insuranceRiskLevel         String? // Cached from classification
  estimatedValue             Decimal? @db.Decimal(12, 2)
  requiresManualUnderwriting Boolean  @default(false)
  insuranceNotes             String?  @db.Text

  // ===== INSURANCE-REQUIRED VEHICLE INFORMATION =====

  // Ownership Information (Optional for now, backfill later)
  registeredOwner String? // ✅ OPTIONAL - Legal owner name
  titleStatus     String  @default("Clean") // "Clean", "Salvage", "Rebuilt"

  // Garage Location (Optional for now, backfill later)
  garageAddress String? // ✅ OPTIONAL - Where vehicle is garaged overnight
  garageCity    String? // ✅ OPTIONAL
  garageState   String? // ✅ OPTIONAL
  garageZip     String? // ✅ OPTIONAL

  // Safety & Security Features (affects premium)
  hasAlarm       Boolean @default(false)
  hasTracking    Boolean @default(false)
  hasImmobilizer Boolean @default(false)

  // Modifications (affects coverage)
  isModified    Boolean @default(false)
  modifications String? @db.Text // Turbo, lift kit, body kit, etc.

  // Usage Information
  annualMileage Int?   @default(12000) // Expected yearly miles
  primaryUse    String @default("Rental") // "Rental", "Personal", "Commercial"

  // ===== NEW: DECLARATION-BASED INSURANCE INTEGRITY SYSTEM =====
  declarationType String @default("Rental") // "Rental", "Rental+Personal", "Commercial"
  // ===== END DECLARATION SYSTEM =====

  // Lienholder Information (if financed)
  hasLien           Boolean @default(false)
  lienholderName    String?
  lienholderAddress String? // ✅ NEW FIELD ADDED

  // ===== NEW: DOCUMENT VERIFICATION TRACKING =====
  vinVerifiedBy         String? // adminId who verified VIN
  vinVerifiedAt         DateTime? // When VIN was verified
  vinVerificationMethod String? // "MANUAL", "API", "PHOTO_OCR"

  registrationVerifiedBy String? // adminId who verified registration
  registrationVerifiedAt DateTime? // When registration verified
  registrationExpiryDate DateTime? // Registration expiration
  registrationState      String? // Registration state

  insuranceVerifiedBy String? // adminId who verified insurance
  insuranceVerifiedAt DateTime? // When insurance verified
  insuranceExpiryDate DateTime? // Insurance policy expiration

  titleVerifiedBy String? // adminId who verified title
  titleVerifiedAt DateTime? // When title verified
  // ===== END DOCUMENT VERIFICATION FIELDS =====

  // ===== END INSURANCE-REQUIRED FIELDS =====

  // ===== NEW: CLAIM BLOCKING FIELDS =====
  hasActiveClaim     Boolean   @default(false)
  activeClaimId      String?
  claimDeactivatedAt DateTime?

  // ===== NEW: CLAIM METRICS TRACKING =====
  totalClaimsCount Int       @default(0)
  lastClaimDate    DateTime?
  claimFreeMonths  Int       @default(0)

  // ===== NEW: CLAIM LOCKING & SAFETY =====
  claimLockUntil     DateTime?
  safetyHold         Boolean   @default(false)
  safetyHoldReason   String?
  requiresInspection Boolean   @default(false)

  // ===== PHASE 2A: REPAIR VERIFICATION =====
  repairVerified Boolean @default(false)

  // ===== NEW: PER-VEHICLE ESG TRACKING =====
  esgScore              Int?      @default(50)
  esgLastCalculated     DateTime?
  esgEnvironmentalScore Int?
  esgSafetyScore        Int?
  esgMaintenanceScore   Int?

  // ===== NEW: TELEMATICS PROXY =====
  avgMilesPerTrip       Float?    @default(0)
  mileageVariance       Float?    @default(0)
  lastOdometerCheck     DateTime?
  suspiciousMileageFlag Boolean   @default(false)

  // ===== NEW: BEHAVIORAL SIGNALS =====
  maintenanceCadence Int?   @default(90) // Days between service
  avgResponseTime    Int?   @default(0) // Hours to respond
  guestRatingAvg     Float? @default(5.0)
  // ===== END NEW ESG & BEHAVIORAL FIELDS =====

  // Specifications
  carType        String
  vehicleType    VehicleType @default(RENTAL) // RENTAL or RIDESHARE
  seats          Int
  doors          Int
  transmission   String
  fuelType       String
  driveType      String?  // AWD, FWD, RWD, 4WD - from VIN decode
  mpgCity        Int?
  mpgHighway     Int?
  currentMileage Int?

  // Mileage Intelligence Fields
  lastRentalEndMileage Int? // Mileage at end of last rental
  lastRentalEndDate    DateTime? // When last rental ended

  // Pricing (daily rates)
  dailyRate   Float
  weeklyRate  Float?
  monthlyRate Float?

  // UPDATED DELIVERY FEES - Individual fees per type
  deliveryFee Float @default(35)
  airportFee  Float @default(0)
  hotelFee    Float @default(35)
  homeFee     Float @default(50)

  // Discounts
  weeklyDiscount  Float? @default(0.15)
  monthlyDiscount Float? @default(0.30)

  // Features (JSON array)
  features String

  // Location
  address   String
  city      String
  state     String
  zipCode   String
  latitude  Float?
  longitude Float?

  // Pickup/Delivery options
  airportPickup Boolean @default(false)
  hotelDelivery Boolean @default(true)
  homeDelivery  Boolean @default(false)

  // NEW DELIVERY SETTINGS
  deliveryRadius       Int     @default(10)
  freeDeliveryRadius   Int     @default(0)
  deliveryInstructions String?

  // Availability settings
  isActive        Boolean @default(true)
  instantBook     Boolean @default(true)
  advanceNotice   Int     @default(2)
  minTripDuration Int     @default(1)
  maxTripDuration Int     @default(30)

  // NEW TRIP SETTINGS
  bufferTime         Int    @default(2)
  cancellationPolicy String @default("moderate")
  checkInTime        String @default("10:00")
  checkOutTime       String @default("10:00")

  // NEW MILEAGE SETTINGS
  mileageDaily      Int   @default(200)
  mileageWeekly     Int   @default(1000)
  mileageMonthly    Int   @default(3000)
  mileageOverageFee Float @default(3.0)

  // Rules & Guidelines (JSON)
  rules String?

  // Insurance
  insuranceIncluded Boolean @default(false)
  insuranceDaily    Float   @default(25)

  // Stats
  totalTrips Int   @default(0)
  rating     Float @default(5.0)

  // ===== SERVICE TRACKING =====
  lastOilChange             DateTime?
  lastInspection            DateTime?
  inspectionExpiresAt       DateTime?
  nextOilChangeDue          DateTime?
  nextInspectionDue         DateTime?
  serviceOverdue            Boolean   @default(false)
  inspectionExpired         Boolean   @default(false)
  highUsageInspectionNeeded Boolean   @default(false)
  // ===== END SERVICE TRACKING =====

  // Relations
  host               RentalHost                 @relation(fields: [hostId], references: [id])
  photos             RentalCarPhoto[]
  bookings           RentalBooking[]
  availability       RentalAvailability[]
  reviews            RentalReview[]
  insuranceOverrides VehicleInsuranceOverride[]
  coverageOverrides  VehicleCoverageOverride[]
  serviceRecords     VehicleServiceRecord[]
  mileageAnomalies   MileageAnomaly[]
  vehicleManagement  VehicleManagement?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([hostId])
  @@index([city, state])
  @@index([carType])
  @@index([isActive, instantBook])
  @@index([classificationId])
  @@index([make, model, year])
  @@index([vin])
  @@index([insuranceEligible])
  @@index([hasActiveClaim])
  @@index([activeClaimId])
  @@index([totalClaimsCount])
  @@index([lastClaimDate])
  @@index([titleStatus])
  @@index([hasAlarm])
  @@index([hasTracking])
  @@index([isModified])
  @@index([hasLien])
  @@index([registeredOwner])
  @@index([vinVerifiedBy])
  @@index([registrationVerifiedBy])
  @@index([insuranceVerifiedBy])
}

// ============================================================================
// RENTAL CAR PHOTO MODEL - WITH ENHANCED METADATA & TRACKING
// ============================================================================

model RentalCarPhoto {
  id      String  @id @default(cuid())
  carId   String
  url     String
  caption String?
  isHero  Boolean @default(false)
  order   Int     @default(0)

  // ===== NEW: PHOTO METADATA & TRACKING =====
  uploadedBy     String? // hostId or adminId who uploaded
  uploadedByType String? // "HOST", "ADMIN", "GUEST"

  // EXIF Data (from photo metadata)
  metadata       Json? // Complete EXIF data
  photoTimestamp DateTime? // Original photo timestamp
  gpsLatitude    Float? // GPS coordinates from EXIF
  gpsLongitude   Float? // GPS coordinates from EXIF
  deviceMake     String? // Camera/phone make
  deviceModel    String? // Camera/phone model

  // Verification
  verified   Boolean   @default(false)
  verifiedBy String? // adminId who verified authenticity
  verifiedAt DateTime?
  photoHash  String? // Hash for duplicate detection

  // Soft Delete
  deletedAt DateTime?
  deletedBy String? // Who deleted it

  // ===== NEW: CLAIM PHOTO CONTEXT =====
  relatedClaimId String? // If photo is for a claim
  photoContext   String? // "LISTING", "DAMAGE", "REPAIR", "INSPECTION"
  // ===== END NEW FIELDS =====

  car RentalCar @relation(fields: [carId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([carId])
  @@index([uploadedBy])
  @@index([verified])
  @@index([photoHash])
  @@index([deletedAt])
  @@index([relatedClaimId])
  @@index([photoContext])
}

// ============================================================================
// VEHICLE SERVICE RECORD MODEL - WITH ATTRIBUTION TRACKING
// ============================================================================

model VehicleServiceRecord {
  id    String    @id @default(cuid())
  carId String
  car   RentalCar @relation(fields: [carId], references: [id], onDelete: Cascade)

  // Service Type
  serviceType        ServiceType
  serviceDate        DateTime
  mileageAtService   Int
  nextServiceDue     DateTime?
  nextServiceMileage Int?

  // Service Provider
  shopName       String
  shopAddress    String
  technicianName String?
  invoiceNumber  String?

  // Documentation (REQUIRED)
  receiptUrl          String // Uploaded receipt/invoice
  inspectionReportUrl String? // For inspections

  // Service Details
  itemsServiced String[] // Array of items
  costTotal     Float
  notes         String?

  // ===== NEW: WHO ADDED THIS RECORD (OPTIONAL FOR BACKFILL) =====
  addedBy     String? @default("SYSTEM") // ⭐ OPTIONAL with default for existing records
  addedByType String? @default("HOST") // ⭐ OPTIONAL with default for existing records
  // ===== END NEW FIELDS =====

  // Verification
  verifiedByFleet Boolean   @default(false)
  verifiedAt      DateTime?
  verifiedBy      String? // Fleet admin ID

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([carId, serviceDate])
  @@index([carId, serviceType])
  @@index([addedBy])
  @@index([addedByType])
}

// ============================================================================
// MILEAGE ANOMALY MODEL
// ============================================================================

model MileageAnomaly {
  id               String    @id @default(cuid())
  carId            String
  car              RentalCar @relation(fields: [carId], references: [id], onDelete: Cascade)
  detectedAt       DateTime  @default(now())
  lastKnownMileage Int
  currentMileage   Int
  gapMiles         Int
  severity         String // NORMAL | WARNING | CRITICAL
  explanation      String?
  resolved         Boolean   @default(false)
  createdAt        DateTime  @default(now())

  @@index([carId])
  @@index([severity])
  @@index([resolved])
  @@index([detectedAt])
}

model RentalAvailability {
  id          String   @id @default(cuid())
  carId       String
  date        DateTime @db.Date
  isAvailable Boolean  @default(true)
  customPrice Float?
  note        String?

  car RentalCar @relation(fields: [carId], references: [id], onDelete: Cascade)

  @@unique([carId, date])
  @@index([carId, date, isAvailable])
}

// ============================================================================
// NEW: TRIP INSPECTION PHOTO MODEL
// ============================================================================

model TripInspectionPhoto {
  id        String        @id @default(cuid())
  bookingId String
  booking   RentalBooking @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  photoType String // "CHECK_IN" | "CHECK_OUT"
  category  String // "EXTERIOR_FRONT" | "EXTERIOR_BACK" | "INTERIOR" | "ODOMETER" | "FUEL"
  url       String
  caption   String?

  uploadedBy     String
  uploadedByType String // "HOST" | "GUEST"
  uploadedAt     DateTime @default(now())

  // EXIF metadata
  gpsLatitude    Float?
  gpsLongitude   Float?
  photoTimestamp DateTime?

  createdAt DateTime @default(now())

  @@index([bookingId])
  @@index([photoType])
  @@index([uploadedAt])
}

model RentalBooking {
  id          String @id @default(cuid())
  bookingCode String @unique @default(cuid())

  // Parties
  carId    String
  hostId   String
  renterId String?

  // Guest fields for non-authenticated bookings
  guestEmail String?
  guestPhone String?
  guestName  String?

  // Link to reviewer profile for guest dashboard
  reviewerProfileId String?
  reviewerProfile   ReviewerProfile? @relation(fields: [reviewerProfileId], references: [id])

  // UPDATED VERIFICATION STATUS ENUM
  verificationStatus   VerificationStatus @default(PENDING)
  verificationDeadline DateTime?
  verificationNotes    String?
  reviewedBy           String?
  reviewedAt           DateTime?
  documentsSubmittedAt DateTime?

  // Associated hotel booking (if any)
  hotelBookingId String?

  // Dates
  startDate DateTime
  endDate   DateTime
  startTime String
  endTime   String

  // Pickup/Delivery
  pickupLocation  String
  pickupType      String
  deliveryAddress String?
  returnLocation  String?

  // Pricing
  dailyRate     Float
  numberOfDays  Int
  subtotal      Float
  deliveryFee   Float @default(0)
  insuranceFee  Float @default(0)
  serviceFee    Float
  taxes         Float
  totalAmount   Float
  depositAmount Float @default(500)

  // ===== NEW INSURANCE DEPOSIT FIELDS =====
  securityDeposit     Float
  depositHeld         Float
  depositRefunded     Float?
  depositRefundedAt   DateTime?
  depositUsedForClaim Float?
  // ===== END INSURANCE DEPOSIT FIELDS =====

  // ===== NEW: GUEST INSURANCE INFORMATION =====
  guestInsuranceProvider     String?
  guestInsurancePolicyNumber String?
  guestInsuranceActive       Boolean @default(false)
  insuranceHierarchy         Json? // Primary/Secondary/Tertiary breakdown

  // ===== NEW: TRIP INSURANCE POSTURE & BINDING =====
  insuranceSelection     String? // "minimal", "premium", "luxury", "basic"
  insuranceStatus        String? // "guest_provided", "guest_purchased", "host_primary", "platform_primary", "uninsured_blocked"
  insurancePolicyId      String? // Policy ID from Tint/Liberty or internal
  insuranceProvider      String? // "Liberty Mutual", "Host P2P", "Guest Personal", etc.
  insuranceBoundAt       DateTime? // When policy was bound
  depositDiscountApplied Boolean   @default(false) // 50% discount if guest provided insurance
  policySnapshot         Json? // IMMUTABLE snapshot of policy at booking time

  // Insurance tier info
  insuranceTier        String? // "40%", "75%", "90%"
  platformPolicyActive Boolean @default(false) // Is ItWhip/Liberty policy active?

  // ===== PHASE 2A: HOST REVENUE SPLIT & GUEST INSURANCE =====
  hostRevenueSplit       Int?
  guestInsuranceApplied  Boolean @default(false)
  guestInsuranceVerified Boolean @default(false)

  // CHARGE TRACKING FIELDS - FIXED WITH NEW FIELD
  pendingChargesAmount Decimal?  @db.Decimal(10, 2)
  chargesProcessedAt   DateTime?
  finalReceiptSentAt   DateTime?
  chargesNotes         String?   @db.Text

  // Charge management fields - INCLUDING THE MISSING ONE
  chargesWaivedAmount   Decimal? @db.Decimal(10, 2)
  chargesWaivedReason   String?
  chargesAdjustedAmount Decimal? @db.Decimal(10, 2)

  // Status
  status          RentalBookingStatus @default(PENDING)
  paymentStatus   PaymentStatus       @default(PENDING)
  paymentIntentId String?

  // STRIPE PAYMENT FIELDS
  stripeCustomerId      String?
  stripePaymentMethodId String?
  stripeChargeId        String?
  stripeSetupIntentId   String?
  paymentFailureReason  String?
  paymentProcessedAt    DateTime?

  // Cancellation tracking
  cancellationReason String?
  cancelledBy        CancelledBy?
  cancelledAt        DateTime?

  // Verification
  licenseVerified   Boolean   @default(false)
  licenseNumber     String?
  licenseState      String?
  licenseExpiry     DateTime?
  licensePhotoUrl   String?
  insurancePhotoUrl String?
  selfieVerified    Boolean   @default(false)
  selfiePhotoUrl    String?
  dateOfBirth       DateTime?

  // FRAUD PREVENTION FIELDS
  bookingIpAddress  String?
  bookingUserAgent  String?
  bookingCountry    String?
  bookingCity       String?
  deviceFingerprint String?
  sessionId         String?
  sessionStartedAt  DateTime?
  sessionDuration   Int?

  // Risk Assessment
  riskScore        Int?    @default(0)
  riskFlags        String?
  riskNotes        String?
  fraudulent       Boolean @default(false)
  flaggedForReview Boolean @default(false)

  // Behavioral Tracking
  formCompletionTime  Int?
  fieldChangeCount    Int?
  copyPasteUsed       Boolean @default(false)
  mouseEventsRecorded Boolean @default(false)

  // Email/Phone Verification
  emailVerified Boolean @default(false)
  emailDomain   String?
  phoneVerified Boolean @default(false)
  phoneCarrier  String?
  phoneType     String?

  // TRIP TRACKING FIELDS
  tripStatus             TripStatus @default(NOT_STARTED)
  pickupWindowStart      DateTime?
  pickupWindowEnd        DateTime?
  pickupLatitude         Float?
  pickupLongitude        Float?
  returnLatitude         Float?
  returnLongitude        Float?
  pickupLocationVerified Boolean    @default(false)
  partnerLocationId      String?

  tripStartedAt DateTime?
  tripEndedAt   DateTime?

  // ===== TRIP COMPLETION TRACKING =====
  tripCompletedBy      String? // "GUEST" | "ADMIN" | "SYSTEM"
  adminCompletedById   String?
  adminCompletionNotes String? @db.Text

  // ===== TRIP END REQUEST (Host-initiated when guest doesn't end trip) =====
  tripEndRequestedAt   DateTime?
  tripEndRequestedBy   String? // 'HOST' | 'GUEST' | 'SYSTEM'
  tripEndRequestReason String?   @db.Text
  tripEndRequestStatus String? // 'PENDING' | 'APPROVED' | 'DENIED'
  tripEndApprovedBy    String?
  tripEndApprovedAt    DateTime?
  tripEndDeniedReason  String?

  // Check-in/out
  actualStartTime DateTime?
  actualEndTime   DateTime?
  startMileage    Int?
  endMileage      Int?
  fuelLevelStart  String?
  fuelLevelEnd    String?

  // INSPECTION FIELDS
  inspectionPhotosStart String?
  inspectionPhotosEnd   String?
  damageReported        Boolean @default(false)
  damageDescription     String? @db.Text
  damagePhotos          String?

  // Extras (JSON)
  extras String?
  notes  String?

  // Relations
  car                  RentalCar             @relation(fields: [carId], references: [id])
  host                 RentalHost            @relation(fields: [hostId], references: [id])
  renter               User?                 @relation("RenterBookings", fields: [renterId], references: [id])
  messages             RentalMessage[]
  review               RentalReview?
  guestAccessTokens    GuestAccessToken[]
  hostPayouts          HostPayout[]
  disputes             RentalDispute[]
  bookingSession       BookingSession?
  fraudIndicators      FraudIndicator[]
  inspectionPhotos     InspectionPhoto[]
  tripCharges          TripCharge[]
  chargeAdjustments    ChargeAdjustment[]
  rentalPayouts        RentalPayout[]
  insurancePolicy      InsurancePolicy?
  claims               Claim[]
  tripInspectionPhotos TripInspectionPhoto[]
  tripIssue            TripIssue? // Pre-claim issue tracking

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([renterId])
  @@index([carId])
  @@index([hostId])
  @@index([status])
  @@index([startDate, endDate])
  @@index([guestEmail])
  @@index([riskScore])
  @@index([fraudulent])
  @@index([bookingIpAddress])
  @@index([deviceFingerprint])
  @@index([stripeCustomerId])
  @@index([paymentStatus])
  @@index([tripStatus])
  @@index([verificationStatus])
  @@index([reviewerProfileId])
  @@index([tripCompletedBy])
  @@index([adminCompletedById])
  @@index([tripEndRequestStatus])
}

// ============================================================================
// REVIEW SYSTEM MODELS
// ============================================================================

model ReviewerProfile {
  id              String   @id @default(cuid())
  email           String?  @unique
  name            String
  profilePhotoUrl String?
  memberSince     DateTime @default(now())
  city            String
  state           String   @default("AZ")
  zipCode         String?

  // Link to User account for login
  userId String? @unique
  user   User?   @relation(fields: [userId], references: [id])

  // Dual-Role Account Linking (NEW)
  // Copy of User.legacyDualId for faster queries when checking linked accounts
  legacyDualId String?

  // Personal Information
  phoneNumber String?
  bio         String?   @db.Text
  dateOfBirth DateTime?

  // Address
  address String?

  // Emergency Contact
  emergencyContactName     String?
  emergencyContactPhone    String?
  emergencyContactRelation String?

  // Identity Documents
  governmentIdUrl    String?
  governmentIdType   GovernmentIdType?
  driversLicenseUrl  String?
  selfieUrl          String?
  documentsVerified  Boolean           @default(false)
  documentVerifiedAt DateTime?
  documentVerifiedBy String?

  // ===== NEW: DRIVER LICENSE INFO FOR FNOL =====
  driverLicenseNumber String?
  driverLicenseState  String?
  driverLicenseExpiry DateTime?

  // GUEST INSURANCE FIELDS - CURRENT ACTIVE INSURANCE
  insuranceProvider     String?
  policyNumber          String?
  expiryDate            DateTime?
  hasRideshare          Boolean   @default(false)
  coverageType          String?
  customCoverage        String?
  insuranceCardFrontUrl String?
  insuranceCardBackUrl  String?
  insuranceVerified     Boolean   @default(false)
  insuranceVerifiedAt   DateTime?
  insuranceVerifiedBy   String?
  insuranceNotes        String?   @db.Text
  insuranceAddedAt      DateTime?
  insuranceUpdatedAt    DateTime?
  insuranceCardUrl      String?

  // PASSWORD RESET FIELDS (for guest login)
  resetToken               String?   @unique
  resetTokenExpiry         DateTime?
  resetTokenUsed           Boolean   @default(false)
  lastPasswordReset        DateTime?
  passwordResetAttempts    Int       @default(0)
  passwordResetLastAttempt DateTime?

  // Preferences
  preferredLanguage  String  @default("en")
  preferredCurrency  String  @default("USD")
  emailNotifications Boolean @default(true)
  smsNotifications   Boolean @default(true)
  pushNotifications  Boolean @default(true)

  // Verification Flags
  emailVerified  Boolean @default(false)
  phoneVerified  Boolean @default(false)
  fullyVerified  Boolean @default(false)
  canInstantBook Boolean @default(false)

  // Stats
  tripCount     Int        @default(0)
  reviewCount   Int        @default(0)
  totalTrips    Int        @default(0)
  averageRating Float      @default(0)
  loyaltyPoints Int        @default(0)
  memberTier    MemberTier @default(BRONZE)

  // Profile completion tracking
  profileCompletion Int @default(0)

  // Verification Status
  isVerified Boolean @default(false)

  // SUSPENSION & BAN SYSTEM - GUEST MODERATION
  suspensionLevel     SuspensionLevel?
  suspendedAt         DateTime?
  suspendedReason     String?
  suspendedBy         String?
  suspensionExpiresAt DateTime?
  autoReactivate      Boolean          @default(false)
  notifiedAt          DateTime?
  notificationSent    Boolean          @default(false)

  // Ban System (severe - complete block)
  bannedAt  DateTime?
  banReason String?
  bannedBy  String?

  // Warning System
  warningCount  Int       @default(0)
  lastWarningAt DateTime?

  // NEW FIELDS FOR WARNING CATEGORIZATION & FEATURE RESTRICTIONS
  canBookLuxury          Boolean @default(true)
  canBookPremium         Boolean @default(true)
  requiresManualApproval Boolean @default(false)
  activeWarningCount     Int     @default(0)

  // ===== NEW: ACCOUNT HOLD SYSTEM (FOR CLAIMS) =====
  accountOnHold        Boolean   @default(false)
  accountHoldReason    String?
  accountHoldClaimId   String?
  accountHoldAppliedAt DateTime?

  // Relations
  reviews             RentalReview[]
  bookings            RentalBooking[]
  moderationHistory   GuestModeration[]    @relation("ProfileModeration")
  appeals             GuestAppeal[]        @relation("ProfileAppeals")
  profileStatus       GuestProfileStatus?
  appealNotifications AppealNotification[] @relation("GuestAppealNotifications")
  insuranceHistory    InsuranceHistory[]
  guestInsurance      GuestInsurance[]
  accountHolds        AccountHold[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
  @@index([city, state])
  @@index([userId])
  @@index([documentsVerified])
  @@index([fullyVerified])
  @@index([canInstantBook])
  @@index([memberTier])
  @@index([suspensionLevel])
  @@index([suspendedAt])
  @@index([bannedAt])
  @@index([suspensionExpiresAt])
  @@index([userId, suspensionLevel])
  @@index([warningCount])
  @@index([activeWarningCount])
  @@index([canBookLuxury])
  @@index([canBookPremium])
  @@index([requiresManualApproval])
  @@index([insuranceVerified])
  @@index([expiryDate])
  @@index([resetToken])
  @@index([accountOnHold])
  @@index([accountHoldClaimId])
  @@index([driverLicenseNumber])
  @@index([driverLicenseExpiry])
  @@index([legacyDualId])
}

// ============================================================================
// PHASE 2A: NEW GUEST INSURANCE MODEL
// ============================================================================

model GuestInsurance {
  id      String          @id @default(cuid())
  guestId String
  guest   ReviewerProfile @relation(fields: [guestId], references: [id], onDelete: Cascade)

  providerName String
  policyNumber String
  verified     Boolean   @default(false)
  verifiedAt   DateTime?
  expiresAt    DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([guestId])
  @@index([verified])
  @@index([expiresAt])
}

// ============================================================================
// PHASE 2A: NEW ACCOUNT HOLD MODEL
// ============================================================================

model AccountHold {
  id      String          @id @default(cuid())
  guestId String
  guest   ReviewerProfile @relation(fields: [guestId], references: [id], onDelete: Cascade)

  reason  String
  amount  Decimal @db.Decimal(10, 2)
  claimId String?

  active    Boolean   @default(true)
  startedAt DateTime  @default(now())
  endedAt   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([guestId])
  @@index([active])
  @@index([claimId])
}

// ============================================================================
// INSURANCE HISTORY MODEL - COMPLETE AUDIT TRAIL
// ============================================================================

model InsuranceHistory {
  id String @id @default(cuid())

  // Relations
  reviewerProfileId String
  reviewerProfile   ReviewerProfile @relation(fields: [reviewerProfileId], references: [id], onDelete: Cascade)

  // Action & Status
  action String
  status String

  // Insurance Details (Snapshot at time of change)
  insuranceProvider     String?
  policyNumber          String?
  expiryDate            DateTime?
  hasRideshare          Boolean   @default(false)
  coverageType          String?
  customCoverage        String?
  insuranceCardFrontUrl String?
  insuranceCardBackUrl  String?
  insuranceNotes        String?   @db.Text

  // Verification Details
  verificationStatus String    @default("UNVERIFIED")
  verifiedBy         String?
  verifiedAt         DateTime?

  // Change Tracking
  changedBy String
  changedAt DateTime @default(now())

  // Additional Metadata
  changeReason String? @db.Text
  ipAddress    String?
  userAgent    String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([reviewerProfileId])
  @@index([reviewerProfileId, status])
  @@index([expiryDate])
  @@index([verificationStatus])
  @@map("insurance_history")
}

// ============================================================================
// GUEST PROFILE STATUS MODEL
// ============================================================================

model GuestProfileStatus {
  id      String          @id @default(cuid())
  guestId String          @unique
  guest   ReviewerProfile @relation(fields: [guestId], references: [id], onDelete: Cascade)

  // Current status
  accountStatus      String   @default("ACTIVE")
  activeWarningCount Int      @default(0)
  activeSuspensions  Int      @default(0)
  activeRestrictions String[] @default([])

  // Complete history (JSON)
  statusHistory       Json @default("[]")
  restrictionHistory  Json @default("[]")
  notificationHistory Json @default("[]")

  // Last action tracking
  lastWarningAt      DateTime?
  lastSuspensionAt   DateTime?
  lastNotificationAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([guestId])
  @@index([accountStatus])
  @@index([activeWarningCount])
  @@index([activeSuspensions])
  @@index([lastWarningAt])
  @@index([lastSuspensionAt])
}

// ============================================================================
// GUEST MODERATION MODEL
// ============================================================================

model GuestModeration {
  id           String          @id @default(cuid())
  guestId      String
  guestProfile ReviewerProfile @relation("ProfileModeration", fields: [guestId], references: [id], onDelete: Restrict)

  // Action details
  actionType      ModerationType
  suspensionLevel SuspensionLevel?
  warningCategory WarningCategory?

  // Reason tracking (dual visibility)
  publicReason      String
  internalNotes     String? @db.Text
  internalNotesOnly Boolean @default(false)

  // Admin tracking
  takenBy String
  takenAt DateTime @default(now())

  // Expiry (for temporary suspensions and warnings)
  expiresAt DateTime?

  // Feature restrictions
  restrictionsApplied Json?

  // Related entities (strings - no foreign keys for audit permanence)
  relatedBookingId String?
  relatedClaimId   String?

  // Relations
  appeals GuestAppeal[]

  @@index([guestId, takenAt])
  @@index([actionType])
  @@index([takenBy])
  @@index([expiresAt])
  @@index([warningCategory])
}

// ============================================================================
// GUEST APPEAL MODEL
// ============================================================================

model GuestAppeal {
  id      String          @id @default(cuid())
  guestId String
  guest   ReviewerProfile @relation("ProfileAppeals", fields: [guestId], references: [id], onDelete: Restrict)

  moderationId String
  moderation   GuestModeration @relation(fields: [moderationId], references: [id], onDelete: Restrict)

  // Appeal content
  reason   String @db.Text
  evidence Json?

  // Appeal status
  status      AppealStatus @default(PENDING)
  reviewedBy  String?
  reviewedAt  DateTime?
  reviewNotes String?      @db.Text

  // Timestamps
  submittedAt DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  notifications AppealNotification[] @relation("AppealNotifications")

  @@index([guestId])
  @@index([status])
  @@index([moderationId])
}

// ============================================================================
// APPEAL NOTIFICATION MODEL
// ============================================================================

model AppealNotification {
  id          String    @id @default(cuid())
  guestId     String
  appealId    String
  type        String
  message     String?   @db.Text
  seen        Boolean   @default(false)
  dismissedAt DateTime?
  createdAt   DateTime  @default(now())

  // Relations
  guest  ReviewerProfile @relation("GuestAppealNotifications", fields: [guestId], references: [id], onDelete: Cascade)
  appeal GuestAppeal     @relation("AppealNotifications", fields: [appealId], references: [id], onDelete: Cascade)

  @@index([guestId, seen])
  @@index([appealId])
}

model RentalReview {
  id                String  @id @default(cuid())
  bookingId         String? @unique
  carId             String
  hostId            String
  renterId          String?
  reviewerProfileId String?

  // Review source tracking
  source ReviewSource @default(GUEST)

  // Ratings
  rating        Int
  cleanliness   Int?
  accuracy      Int?
  communication Int?
  convenience   Int?
  value         Int?

  // Review content
  title   String?
  comment String? @db.Text

  // Host Response Fields
  hostResponse    String?   @db.Text
  hostRespondedAt DateTime?

  // Support Response Fields
  supportResponse    String?   @db.Text
  supportRespondedAt DateTime?
  supportRespondedBy String?

  // Trip information
  tripStartDate DateTime?
  tripEndDate   DateTime?

  // Visibility and prominence
  isVisible  Boolean @default(true)
  isPinned   Boolean @default(false)
  isVerified Boolean @default(false)

  // Engagement metrics
  helpfulCount Int @default(0)
  viewCount    Int @default(0)

  // Relations
  booking         RentalBooking?   @relation(fields: [bookingId], references: [id])
  car             RentalCar        @relation(fields: [carId], references: [id])
  host            RentalHost       @relation(fields: [hostId], references: [id])
  reviewerProfile ReviewerProfile? @relation(fields: [reviewerProfileId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([carId])
  @@index([hostId])
  @@index([source])
  @@index([isVisible])
  @@index([isPinned])
  @@index([tripStartDate])
}

model ReviewTemplate {
  id       String @id @default(cuid())
  carType  String
  scenario String
  tone     String

  // Template content with placeholders
  titleTemplate   String
  commentTemplate String @db.Text

  // Metadata
  usageCount Int     @default(0)
  isActive   Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([carType])
  @@index([scenario])
  @@index([isActive])
}

// ============================================================================
// TRIP CHARGE & ADJUSTMENT MODELS
// ============================================================================

model TripCharge {
  id        String        @id @default(cuid())
  bookingId String
  booking   RentalBooking @relation(fields: [bookingId], references: [id])

  // Charge details
  mileageCharge  Decimal @db.Decimal(10, 2)
  fuelCharge     Decimal @db.Decimal(10, 2)
  lateCharge     Decimal @db.Decimal(10, 2)
  damageCharge   Decimal @db.Decimal(10, 2)
  cleaningCharge Decimal @db.Decimal(10, 2)
  otherCharges   Decimal @db.Decimal(10, 2)
  totalCharges   Decimal @db.Decimal(10, 2)

  // Charge breakdown details (JSON)
  chargeDetails String?

  // Status
  chargeStatus   ChargeStatus @default(PENDING)
  chargeAttempts Int          @default(0)
  lastAttemptAt  DateTime?
  nextRetryAt    DateTime?

  // Disputes
  disputes          String?
  disputeNotes      String?   @db.Text
  disputedAt        DateTime?
  disputeResolvedAt DateTime?
  disputeResolution String?

  // Payment tracking
  stripeChargeId String?
  chargedAt      DateTime?
  chargedAmount  Decimal?  @db.Decimal(10, 2)
  failureReason  String?
  failureCode    String?

  // Waive/Adjustment tracking
  originalAmount     Decimal?  @db.Decimal(10, 2)
  adjustedAmount     Decimal?  @db.Decimal(10, 2)
  waivedAt           DateTime?
  waivedBy           String?
  waivedByAdminId    String?
  processedByAdminId String?
  waiveReason        String?
  waivePercentage    Int?
  adjustmentNotes    String?   @db.Text
  adjustmentRecord   Json?

  // Refund tracking
  refundAmount   Decimal?  @db.Decimal(10, 2)
  refundedAt     DateTime?
  refundReason   String?
  stripeRefundId String?

  // Admin review
  reviewedBy       String?
  reviewedAt       DateTime?
  adminNotes       String?   @db.Text
  requiresApproval Boolean   @default(false)
  approvedBy       String?
  approvedAt       DateTime?

  // Hold period tracking
  holdUntil       DateTime?
  guestNotifiedAt DateTime?
  reminderSentAt  DateTime?

  // Relations
  adjustments ChargeAdjustment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([bookingId])
  @@index([chargeStatus])
  @@index([holdUntil])
  @@index([requiresApproval])
}

model ChargeAdjustment {
  id        String  @id @default(cuid())
  bookingId String
  chargeId  String?

  // Adjustment details
  adjustmentType String
  reason         String

  // Amounts
  originalAmount   Decimal @db.Decimal(10, 2)
  adjustedAmount   Decimal @db.Decimal(10, 2)
  reductionAmount  Decimal @db.Decimal(10, 2)
  reductionPercent Int?

  // Detailed adjustments (JSON)
  adjustmentDetails String?

  // Admin action
  adminId    String
  adminEmail String
  adminNotes String? @db.Text

  // Processing
  processedAt      DateTime?
  stripeChargeId   String?
  stripeRefundId   String?
  processingStatus String    @default("pending")
  failureReason    String?

  // Relations
  booking    RentalBooking @relation(fields: [bookingId], references: [id])
  tripCharge TripCharge?   @relation(fields: [chargeId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([bookingId])
  @@index([chargeId])
  @@index([adminId])
  @@index([processingStatus])
}

// ============================================================================
// INSPECTION & FRAUD MODELS
// ============================================================================

model InspectionPhoto {
  id         String   @id @default(cuid())
  bookingId  String
  type       String
  category   String
  url        String
  metadata   Json?
  uploadedAt DateTime @default(now())

  booking RentalBooking @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@index([bookingId])
  @@index([type])
}

model BookingSession {
  id        String         @id @default(cuid())
  bookingId String?        @unique
  booking   RentalBooking? @relation(fields: [bookingId], references: [id])

  // Session tracking
  sessionId   String    @unique
  startedAt   DateTime  @default(now())
  completedAt DateTime?
  duration    Int?
  abandoned   Boolean   @default(false)

  // Page flow tracking
  pageViews String?
  lastPage  String?

  // Interaction metrics
  clickCount  Int     @default(0)
  scrollDepth Float?
  timeOnPage  String?

  // Form behavior
  fieldTimings     String?
  fieldFocusCount  String?
  validationErrors Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([sessionId])
  @@index([abandoned])
}

model FraudIndicator {
  id        String        @id @default(cuid())
  bookingId String
  booking   RentalBooking @relation(fields: [bookingId], references: [id])

  indicator  String
  severity   FraudSeverity
  confidence Float
  details    String?
  source     String

  createdAt DateTime @default(now())

  @@index([bookingId])
  @@index([severity])
  @@index([indicator])
}

// ============================================================================
// GUEST & MESSAGE MODELS
// ============================================================================

model GuestAccessToken {
  id        String    @id @default(cuid())
  token     String    @unique @default(cuid())
  bookingId String
  email     String
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  booking RentalBooking @relation(fields: [bookingId], references: [id])

  @@index([token])
  @@index([email])
}

model RentalMessage {
  id         String  @id @default(cuid())
  bookingId  String
  senderId   String
  senderType String
  message    String  @db.Text
  isRead     Boolean @default(false)

  // Enhanced messaging fields
  senderName     String?
  senderEmail    String?
  category       String    @default("general")
  hasAttachment  Boolean   @default(false)
  attachmentUrl  String?
  attachmentName String?
  isUrgent       Boolean   @default(false)
  readByAdmin    Boolean   @default(false)
  adminNotes     String?   @db.Text
  readAt         DateTime?
  metadata       Json?

  // Reply tracking
  replyToId String?

  booking RentalBooking @relation(fields: [bookingId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([bookingId])
  @@index([createdAt])
  @@index([isRead, readByAdmin])
  @@index([category])
  @@index([senderType])
}

// ============================================================================
// PAYOUT & FINANCIAL MODELS
// ============================================================================

model RentalPayout {
  id       String @id @default(cuid())
  hostId   String
  amount   Float
  currency String @default("USD")
  status   String

  // NEW FIELDS - Per-booking payout tracking
  bookingId  String?
  eligibleAt DateTime?

  // EXISTING FIELDS - Keep for backward compatibility
  startDate DateTime
  endDate   DateTime

  // Breakdown
  bookingCount  Int
  grossEarnings Float
  platformFee   Float
  processingFee Float
  netPayout     Float

  // Payment details
  paymentMethod    String?
  paymentDetails   String?
  transactionId    String?
  stripeTransferId String?
  processedAt      DateTime?

  // Relations
  host    RentalHost     @relation(fields: [hostId], references: [id])
  booking RentalBooking? @relation(fields: [bookingId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([hostId])
  @@index([status])
  @@index([eligibleAt, status])
  @@index([hostId, status, processedAt])
}

model HostPayout {
  id               String       @id @default(cuid())
  hostId           String
  bookingId        String
  amount           Decimal      @db.Decimal(10, 2)
  status           PayoutStatus @default(PENDING)
  processedAt      DateTime?
  stripeTransferId String?
  createdAt        DateTime     @default(now())

  host    RentalHost    @relation(fields: [hostId], references: [id])
  booking RentalBooking @relation(fields: [bookingId], references: [id])

  @@index([hostId])
  @@index([status])
}

// ============================================================================
// HOST INQUIRY & ADMIN MODELS
// ============================================================================

model HostInquiry {
  id String @id @default(cuid())

  // Contact Information
  name  String
  email String
  phone String

  // Vehicle Information
  vehicleMake  String
  vehicleModel String
  vehicleYear  Int
  location     String @default("Phoenix")

  // Additional Details
  message   String? @db.Text
  mileage   Int?
  condition String  @default("EXCELLENT")
  features  String? @db.Text

  // Status Tracking
  status String @default("NEW")
  source String @default("WEBSITE")

  // Response Tracking
  contactedAt     DateTime?
  contactedBy     String?
  approvedAt      DateTime?
  approvedBy      String?
  rejectedAt      DateTime?
  rejectedBy      String?
  rejectionReason String?   @db.Text

  // Host Conversion
  convertedToHostId String?
  convertedAt       DateTime?

  // Store replies as JSON array
  replies    Json? @default("[]")
  replyCount Int   @default(0)

  // Metadata
  metadata Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([email])
  @@index([createdAt])
}

model AdminNotification {
  id String @id @default(cuid())

  // Notification Details
  type    String
  title   String
  message String @db.Text

  // Priority & Status
  priority String @default("MEDIUM")
  status   String @default("UNREAD")

  // Related Entity
  relatedId   String?
  relatedType String?

  // Action & Response
  actionRequired Boolean   @default(false)
  actionUrl      String?
  resolvedBy     String?
  resolvedAt     DateTime?
  resolution     String?   @db.Text

  // Metadata
  metadata Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([type])
  @@index([status])
  @@index([priority])
  @@index([createdAt])
}

model ContactMessage {
  id      String        @id @default(cuid())
  name    String
  email   String
  phone   String?
  subject String
  message String        @db.Text
  status  MessageStatus @default(UNREAD)

  // Reply tracking
  repliedAt DateTime?
  repliedBy String?

  // Store replies as JSON array
  replies    Json? @default("[]")
  replyCount Int   @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([email])
}

model RentalDispute {
  id          String        @id @default(cuid())
  bookingId   String
  type        DisputeType
  description String        @db.Text
  status      DisputeStatus @default(OPEN)
  resolution  String?       @db.Text
  createdAt   DateTime      @default(now())
  resolvedAt  DateTime?

  // Fields for dispute review tracking
  reviewStartedAt DateTime?
  reviewedBy      String?

  booking RentalBooking @relation(fields: [bookingId], references: [id])

  @@index([bookingId])
  @@index([status])
}

// ============================================================================
// ACTIVITY LOG MODEL - WITH ENHANCED TRACKING
// ============================================================================

model ActivityLog {
  id         String   @id @default(cuid())
  userId     String?
  action     String
  entityType String
  entityId   String
  metadata   Json?
  ipAddress  String?
  createdAt  DateTime @default(now())

  // ===== NEW: ENHANCED TRACKING =====
  userAgent String? // Browser/device info
  adminId   String? // If action by admin
  hostId    String? // If action by host
  guestId   String? // If action by guest

  // Change tracking
  oldValue String? @db.Text // Before change
  newValue String? @db.Text // After change

  // Impact tracking
  severity String? @default("INFO") // INFO, WARNING, ERROR, CRITICAL
  category String? // DOCUMENT, PHOTO, SERVICE, STATUS, COMPLIANCE
  // ===== END NEW FIELDS =====

  user User? @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([entityType])
  @@index([createdAt])
  @@index([adminId])
  @@index([hostId])
  @@index([severity])
  @@index([category])
}

model AmadeusCarCache {
  id         String   @id @default(cuid())
  location   String
  searchDate DateTime
  carData    String
  expiresAt  DateTime

  @@index([location, searchDate])
  @@index([expiresAt])
}

// ============================================================================
// CAREER/JOB MODELS
// ============================================================================

model JobPosting {
  id String @id @default(cuid())

  // Basic Information
  title      String
  department String
  location   String
  type       JobType

  // Detailed Description
  description      String  @db.Text
  requirements     String  @db.Text
  responsibilities String  @db.Text
  qualifications   String? @db.Text
  benefits         String? @db.Text

  // Compensation
  salaryMin    Int?
  salaryMax    Int?
  salaryPeriod String? @default("yearly")
  showSalary   Boolean @default(true)
  equity       String?

  // Experience Requirements
  experienceMin      Int?
  experienceMax      Int?
  experienceRequired String?

  // Status & Display
  isActive      Boolean @default(true)
  isFeatured    Boolean @default(false)
  isRemote      Boolean @default(false)
  openPositions Int     @default(1)

  // Application Settings
  applyUrl   String?
  applyEmail String?

  // Tracking & Analytics
  views            Int @default(0)
  applicationCount Int @default(0)

  // Dates
  postedDate  DateTime  @default(now())
  closingDate DateTime?
  filledDate  DateTime?

  // Relations
  applications JobApplication[]

  // Metadata
  keywords String?
  metadata Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive])
  @@index([department])
  @@index([location])
  @@index([type])
  @@index([postedDate])
}

model JobApplication {
  id String @id @default(cuid())

  // Job Reference
  jobId String
  job   JobPosting @relation(fields: [jobId], references: [id])

  // Applicant Information
  firstName String
  lastName  String
  email     String
  phone     String

  // Professional Links
  linkedin  String?
  github    String?
  portfolio String?
  website   String?

  // Documents
  resumeUrl         String
  coverLetter       String? @db.Text
  coverLetterUrl    String?
  additionalDocsUrl String?

  // Application Details
  yearsExperience Int?
  currentCompany  String?
  currentTitle    String?
  expectedSalary  Int?
  availableDate   DateTime?

  // Screening Questions (stored as JSON)
  screeningAnswers Json?

  // Status Tracking
  status ApplicationStatus @default(NEW)
  stage  String?
  rating Int?

  // Internal Notes & Review
  notes      String?   @db.Text
  reviewedBy String?
  reviewedAt DateTime?

  // Communication Tracking
  lastContactedAt DateTime?
  interviewDate   DateTime?
  offerDate       DateTime?
  offerAmount     Int?

  // Source Tracking
  source      String?
  referredBy  String?
  utmSource   String?
  utmMedium   String?
  utmCampaign String?

  // Rejection/Withdrawal
  rejectionReason String?
  withdrawnReason String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([jobId, email])
  @@index([jobId])
  @@index([status])
  @@index([email])
  @@index([createdAt])
}

model ApplicationActivity {
  id            String   @id @default(cuid())
  applicationId String
  action        String
  performedBy   String
  details       Json?
  createdAt     DateTime @default(now())

  @@index([applicationId])
  @@index([createdAt])
}

// ============================================================================
// REVENUE MODELS
// ============================================================================

model Revenue {
  id      String @id @default(cuid())
  hotelId String
  hotel   Hotel  @relation(fields: [hotelId], references: [id])

  // Period
  period    RevenuePeriod
  startDate DateTime
  endDate   DateTime

  // Ride revenue
  rideCount      Int
  rideGross      Float
  rideCommission Float
  platformFee    Float
  rideNet        Float

  // Booking revenue
  bookingCount    Int
  bookingValue    Float
  savedCommission Float

  // Totals
  totalRevenue Float
  currency     String @default("USD")

  // Payout
  status           RevenueStatus
  availableBalance Float
  pendingBalance   Float

  calculatedAt DateTime @default(now())

  @@unique([hotelId, period, startDate])
  @@index([hotelId])
  @@index([status])
}

model Transaction {
  id      String @id @default(cuid())
  hotelId String

  // Type
  type     TransactionType
  category String

  // Amount
  amount   Float
  currency String @default("USD")

  // References
  rideId    String?
  bookingId String?

  // Status
  status TransactionStatus

  description String
  metadata    String?

  createdAt   DateTime  @default(now())
  processedAt DateTime?

  @@index([hotelId])
  @@index([type])
  @@index([status])
}

// ============================================================================
// SECURITY & AUDIT MODELS
// ============================================================================

model AuditLog {
  id String @id @default(cuid())

  // Event categorization
  category  AuditCategory
  eventType String
  severity  AuditSeverity

  // Actor information
  userId     String?
  user       User?   @relation(fields: [userId], references: [id])
  adminId    String?
  adminEmail String?
  hotelId    String?

  // Request context
  ipAddress String
  userAgent String
  sessionId String?
  requestId String?

  // Action details
  action     String
  resource   String
  resourceId String?

  // Financial tracking (for charge-related events)
  amount   Decimal? @db.Decimal(10, 2)
  currency String?  @default("USD")
  stripeId String?

  // Detailed information
  details  Json?
  changes  Json?
  metadata Json?

  // Compliance flags
  gdpr Boolean @default(false)
  ccpa Boolean @default(false)
  pci  Boolean @default(false)
  sox  Boolean @default(false)

  // Data integrity
  hash         String
  previousHash String?
  verified     Boolean @default(false)

  // Backup/Archive status
  backedUp   Boolean   @default(false)
  archivedAt DateTime?

  timestamp DateTime @default(now())

  @@index([userId])
  @@index([adminId])
  @@index([adminEmail])
  @@index([hotelId])
  @@index([category])
  @@index([eventType])
  @@index([timestamp])
  @@index([resourceId])
  @@index([severity])
}

model SecurityEvent {
  id       String         @id @default(cuid())
  type     String
  severity ThreatSeverity

  // Source
  sourceIp  String
  userAgent String
  country   String?
  city      String?

  // Target
  targetResource String?
  targetId       String?

  // Details
  message    String
  details    String?
  stackTrace String?

  // Response
  action  String
  blocked Boolean @default(false)

  timestamp DateTime @default(now())

  @@index([type])
  @@index([severity])
  @@index([sourceIp])
  @@index([timestamp])
}

model Threat {
  id       String         @id @default(cuid())
  type     AttackType
  severity ThreatSeverity
  status   ThreatStatus

  // Source
  sourceIp   String
  sourceIps  String?
  country    String?
  asn        String?
  reputation Int?

  // Attack details
  method   String
  target   String
  payload  String?
  attempts Int

  // Detection
  detectionMethod String
  confidence      Float
  rules           String?

  // Mitigation
  automated    Boolean
  actions      String?
  blockedUntil DateTime?

  firstSeen DateTime
  lastSeen  DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([type])
  @@index([severity])
  @@index([status])
  @@index([sourceIp])
}

model RateLimit {
  id         String @id @default(cuid())
  identifier String @unique

  // Limits
  tier     String
  requests Int
  window   Int

  // Current usage
  currentRequests Int      @default(0)
  windowStart     DateTime

  // Status
  exceeded    Boolean   @default(false)
  banned      Boolean   @default(false)
  bannedUntil DateTime?

  updatedAt DateTime @updatedAt

  @@index([identifier])
  @@index([exceeded])
}

model LoginAttempt {
  id         String  @id @default(cuid())
  identifier String
  userId     String?
  user       User?   @relation(fields: [userId], references: [id])

  ipAddress String
  userAgent String

  success Boolean
  reason  String?

  timestamp DateTime @default(now())

  @@index([identifier])
  @@index([ipAddress])
  @@index([success])
}

// ============================================================================
// ESG (Environmental, Safety, Governance) SYSTEM
// ============================================================================

// Main ESG Profile for each Host
model HostESGProfile {
  id     String @id @default(cuid())
  hostId String @unique

  // ============================================================================
  // COMPOSITE SCORES (0-100 scale)
  // ============================================================================
  compositeScore     Int @default(50) // Overall ESG score
  drivingImpactScore Int @default(50) // Usage health
  emissionsScore     Int @default(50) // Environmental impact
  maintenanceScore   Int @default(50) // Maintenance compliance
  safetyScore        Int @default(50) // Safety & incident history
  complianceScore    Int @default(50) // Policy compliance

  // ============================================================================
  // SAFETY METRICS
  // ============================================================================
  totalTrips            Int       @default(0) // Total completed trips
  incidentFreeTrips     Int       @default(0) // Trips without incidents
  totalClaimsFiled      Int       @default(0) // Total claims filed
  currentIncidentStreak Int       @default(0) // Current streak of incident-free trips
  longestIncidentStreak Int       @default(0) // Longest incident-free streak ever
  lastIncidentDate      DateTime? // Date of last incident

  // ============================================================================
  // ENVIRONMENTAL METRICS
  // ============================================================================
  totalEVTrips         Int    @default(0) // Total EV trips
  evTripPercentage     Float  @default(0) // % of trips using EV
  estimatedCO2Saved    Float  @default(0) // Estimated CO2 savings (kg)
  totalCO2Impact       Float  @default(0) // ✅ NEW: Total CO2 emitted (kg)
  avgCO2PerMile        Float  @default(0) // ✅ NEW: Average CO2 per mile
  fuelEfficiencyRating String @default("UNKNOWN") // EXCELLENT, GOOD, FAIR, POOR, UNKNOWN

  // ============================================================================
  // COMPLIANCE METRICS
  // ============================================================================
  maintenanceOnTime       Boolean   @default(true) // Is maintenance up to date?
  lastMaintenanceDate     DateTime? // Last maintenance recorded
  overdueMaintenanceCount Int       @default(0) // Number of overdue maintenance items
  fnolCompletionRate      Float     @default(100) // % of claims with complete FNOL
  avgResponseTimeHours    Float     @default(0) // Avg time to respond to claims (hours)

  // ============================================================================
  // FRAUD DETECTION METRICS
  // ============================================================================
  unauthorizedMileage     Float  @default(0) // Detected off-trip mileage
  suspiciousActivityCount Int    @default(0) // Number of flagged activities
  verificationFailures    Int    @default(0) // Failed verification checks
  fraudRiskLevel          String @default("LOW") // LOW, MEDIUM, HIGH, CRITICAL

  // ============================================================================
  // USAGE PATTERN METRICS
  // ============================================================================
  totalMilesDriven   Float @default(0) // Total miles across all trips
  avgMilesPerTrip    Float @default(0) // Average miles per trip
  tripCompletionRate Float @default(100) // % of trips completed successfully
  idleTimeEfficiency Float @default(100) // Idle time vs active time ratio

  // ============================================================================
  // TRIP QUALITY METRICS
  // ============================================================================
  tripCancellationRate Float @default(0) // % of trips cancelled
  lateReturnCount      Int   @default(0) // Number of late returns
  earlyReturnCount     Int   @default(0) // Number of early returns
  guestRatingAverage   Float @default(5.0) // Average guest rating (1-5)

  // ============================================================================
  // VEHICLE FLEET METRICS
  // ============================================================================
  totalVehicles  Int   @default(0) // Total vehicles in fleet
  activeVehicles Int   @default(0) // Currently active vehicles
  evVehicleCount Int   @default(0) // Number of EV vehicles
  avgVehicleAge  Float @default(0) // Average vehicle age (years)

  // ============================================================================
  // INSURANCE & RISK METRICS
  // ============================================================================
  hasCommercialInsurance Boolean @default(false) // Has commercial insurance?
  hasP2PInsurance        Boolean @default(false) // Has P2P insurance?
  insuranceTier          String  @default("PLATFORM") // PLATFORM, P2P, COMMERCIAL
  claimApprovalRate      Float   @default(0) // % of claims approved
  avgClaimProcessingDays Float   @default(0) // Avg days to process claims

  // ============================================================================
  // GAMIFICATION & BADGES
  // ============================================================================
  achievedBadges   String[] @default([]) // Array of badge IDs earned
  milestoneReached String[] @default([]) // Milestones achieved
  nextMilestone    String? // Next milestone to reach

  // ============================================================================
  // SCORE HISTORY (JSON for trend tracking)
  // ============================================================================
  scoreHistory Json @default("[]") // Array of {date, score, breakdown}

  // ============================================================================
  // CALCULATION METADATA
  // ============================================================================
  lastCalculatedAt   DateTime @updatedAt // When scores were last calculated
  calculationVersion String   @default("1.0") // Algorithm version used
  dataConfidence     String   @default("HIGH") // HIGH, MEDIUM, LOW (data quality)

  // ============================================================================
  // TIMESTAMPS
  // ============================================================================
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ============================================================================
  // RELATIONS
  // ============================================================================
  host      RentalHost    @relation("HostESGProfile", fields: [hostId], references: [id], onDelete: Cascade)
  snapshots ESGSnapshot[]

  @@index([hostId])
  @@index([compositeScore])
  @@index([safetyScore])
  @@index([fraudRiskLevel])
}

// ============================================================================
// ESG SNAPSHOTS (Historical records for trend analysis)
// ============================================================================
model ESGSnapshot {
  id        String @id @default(cuid())
  profileId String

  // Snapshot of scores at this point in time
  compositeScore     Int
  drivingImpactScore Int
  emissionsScore     Int
  maintenanceScore   Int
  safetyScore        Int
  complianceScore    Int

  // Snapshot metadata
  snapshotDate   DateTime @default(now())
  snapshotReason String // DAILY_UPDATE, TRIP_COMPLETED, CLAIM_FILED, MANUAL_REFRESH
  triggerEventId String? // ID of trip/claim that triggered this

  // Relations
  profile HostESGProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId])
  @@index([snapshotDate])
}

// ============================================================================
// ESG EVENTS LOG (Audit trail for score changes)
// ============================================================================
model ESGEvent {
  id               String   @id @default(cuid())
  hostId           String
  eventType        String // TRIP_COMPLETED, CLAIM_FILED, etc.
  eventCategory    String // SAFETY, ENVIRONMENTAL, COMPLIANCE, etc.
  scoreBefore      Int?
  scoreAfter       Int?
  scoreChange      Int?
  description      String
  metadata         Json     @default("{}")
  relatedTripId    String?
  relatedClaimId   String?
  relatedBookingId String?
  createdAt        DateTime @default(now())

  @@index([hostId])
  @@index([eventType])
  @@index([eventCategory])
  @@index([createdAt])
}

// ============================================================================
// ESG BADGES & ACHIEVEMENTS
// ============================================================================
model ESGBadge {
  id String @id @default(cuid())

  // Badge details
  badgeCode        String @unique // ECO_WARRIOR, SAFETY_CHAMPION, etc.
  badgeName        String // Display name
  badgeDescription String // What it represents
  badgeIcon        String // Icon/emoji
  badgeCategory    String // SAFETY, ENVIRONMENTAL, COMPLIANCE, MILESTONE

  // Requirements
  requiredScore  Int? // Minimum score needed
  requiredTrips  Int? // Minimum trips needed
  requiredStreak Int? // Minimum streak needed
  requiredMetric String? // Specific metric requirement
  requiredValue  Float? // Required value for metric

  // Metadata
  rarity String @default("COMMON") // COMMON, RARE, EPIC, LEGENDARY
  points Int    @default(0) // Gamification points

  // Timestamps
  createdAt DateTime @default(now())

  @@index([badgeCode])
}

// ============================================================================
// HOST-BADGE JUNCTION (Many-to-many)
// ============================================================================
model HostBadgeEarned {
  id        String @id @default(cuid())
  hostId    String
  badgeCode String

  earnedAt DateTime @default(now())

  @@unique([hostId, badgeCode])
  @@index([hostId])
  @@index([badgeCode])
}

// ============================================================================
// ACCOUNT LINKING SYSTEM
// ============================================================================

model AccountLinkRequest {
  id               String @id @default(cuid())
  initiatingUserId String
  targetEmail      String

  // Verification Code (for host to enter)
  verificationCode String
  codeExpiresAt    DateTime

  // Secure Link Tokens (for clicking email links)
  guestLinkToken String? @unique // Token for guest to click
  hostLinkToken  String? @unique // Token for host (generated when guest confirms)

  // Status tracking
  status       MergeStatus @default(PENDING)
  legacyDualId String?     // Generated after verification

  // Timestamps
  requestedAt      DateTime  @default(now())
  guestConfirmedAt DateTime? // When guest clicked their link
  verifiedAt       DateTime? // When fully completed

  @@index([initiatingUserId])
  @@index([targetEmail])
  @@index([status])
  @@index([guestLinkToken])
  @@index([hostLinkToken])
}

// ============================================================================
// ENUMS
// ============================================================================

enum UserRole {
  ANONYMOUS
  CLAIMED
  STARTER
  BUSINESS
  ENTERPRISE
  ADMIN
}

enum UserStatus {
  ACTIVE
  PENDING_DELETION
  DELETED
  SUSPENDED
}

enum CertificationTier {
  NONE
  TU_3_C
  TU_2_B
  TU_1_A
}

enum PropertyType {
  HOTEL
  RESORT
  MOTEL
  BNB
  BOUTIQUE
  CHAIN
  INDEPENDENT
}

enum HotelSize {
  SMALL
  MEDIUM
  LARGE
  ENTERPRISE
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CHECKED_IN
  CHECKED_OUT
  CANCELLED
  NO_SHOW
}

enum BookingSource {
  DIRECT
  EXPEDIA
  BOOKING_COM
  AIRBNB
  AMADEUS
  SABRE
  WEBSITE
  PHONE
  WALK_IN
}

enum RideStatus {
  REQUESTED
  SEARCHING
  DRIVER_ASSIGNED
  DRIVER_ARRIVED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  GHOST
}

enum RentalBookingStatus {
  PENDING
  CONFIRMED
  ACTIVE
  COMPLETED
  CANCELLED
  NO_SHOW
  DISPUTE_REVIEW
}

enum BackgroundCheckStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  PASSED
  FAILED
  EXPIRED
  ERROR
}

enum NotificationStatus {
  PENDING
  SENT
  DELIVERED
  READ
  RESPONDED
  FAILED
  EXPIRED
}

enum DocumentStatus {
  NOT_UPLOADED
  UPLOADED
  UNDER_REVIEW
  APPROVED
  REJECTED
  EXPIRED
  RESUBMISSION_REQUIRED
}

enum DocumentReviewStatus {
  PENDING
  REVIEWING
  APPROVED
  REJECTED
  NEEDS_CLARIFICATION
}

enum InsuranceProviderType {
  EMBEDDED
  TRADITIONAL
}

enum InsuranceTier {
  MINIMUM
  BASIC
  PREMIUM
  LUXURY
}

enum ClaimType {
  ACCIDENT
  THEFT
  VANDALISM
  CLEANING
  MECHANICAL
  WEATHER
  OTHER
}

enum ClaimStatus {
  PENDING
  UNDER_REVIEW
  APPROVED
  DENIED
  PAID
  DISPUTED
  RESOLVED
  GUEST_RESPONSE_PENDING
  GUEST_RESPONDED
  GUEST_NO_RESPONSE
  VEHICLE_REPAIR_PENDING
  INSURANCE_PROCESSING
  CLOSED
}

enum HostInsuranceStatus {
  ACTIVE
  INACTIVE
  EXPIRED
  DEACTIVATED
  SUSPENDED
  PENDING
}

enum PolicyStatus {
  ACTIVE
  EXPIRED
  CANCELLED
  CLAIMED
}

enum RecoveryStatus {
  PENDING
  PARTIAL
  FULL
  FAILED
  WAIVED
}

enum RevenueStatus {
  PENDING
  AVAILABLE
  PROCESSING
  WITHDRAWN
  HELD
}

enum TransactionType {
  RIDE_COMMISSION
  BOOKING
  WITHDRAWAL
  FEE
  REFUND
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
}

enum ThreatSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum ThreatStatus {
  DETECTED
  INVESTIGATING
  MITIGATED
  BLOCKED
  RESOLVED
  FALSE_POSITIVE
}

enum AuditCategory {
  AUTHENTICATION
  AUTHORIZATION
  DATA_ACCESS
  DATA_MODIFICATION
  CONFIGURATION
  SECURITY
  COMPLIANCE
  FINANCIAL
  CHARGE_MANAGEMENT
  HOST_MANAGEMENT
}

enum AuditSeverity {
  INFO
  WARNING
  ERROR
  CRITICAL
}

enum AttackType {
  BRUTE_FORCE
  DICTIONARY
  SQL_INJECTION
  XSS
  CSRF
  DDOS
  MAN_IN_MIDDLE
  SESSION_HIJACK
  CREDENTIAL_STUFFING
  BOT
}

enum MetricPeriod {
  DAY
  WEEK
  MONTH
  YEAR
}

enum RevenuePeriod {
  DAY
  WEEK
  MONTH
  TOTAL
}

enum MessageStatus {
  UNREAD
  READ
  REPLIED
  ARCHIVED
}

enum PayoutStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum DisputeType {
  DAMAGE
  REFUND
  SERVICE
  MILEAGE
  FUEL
  LATE_RETURN
  CLEANING
  OTHER
}

enum DisputeStatus {
  OPEN
  UNDER_REVIEW
  INVESTIGATING
  RESOLVED
  CLOSED
}

enum CancelledBy {
  GUEST
  ADMIN
  HOST
  SYSTEM
}

enum FraudSeverity {
  INFO
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum VerificationStatus {
  PENDING
  SUBMITTED
  APPROVED
  REJECTED
  PENDING_CHARGES
  DISPUTE_REVIEW
  COMPLETED
}

enum ReviewSource {
  GUEST
  SEED
  MANAGED
  ADMIN
}

enum PaymentStatus {
  PENDING
  AUTHORIZED
  CAPTURED
  PAID
  FAILED
  REFUNDED
  PENDING_CHARGES
  CHARGES_PAID
  CHARGES_WAIVED
  PARTIAL_REFUND
  PARTIAL_PAID
  ADJUSTED_PAID
}

enum TripStatus {
  NOT_STARTED
  ACTIVE
  COMPLETED
  ENDED_PENDING_REVIEW
}

enum ChargeStatus {
  PENDING
  PROCESSING
  CHARGED
  FAILED
  WAIVED
  DISPUTED
  ADJUSTED
  REFUNDED
  PARTIALLY_WAIVED
  PARTIAL_CHARGED
  ADJUSTED_CHARGED
  FULLY_WAIVED
  ADJUSTED_PENDING
  ADJUSTMENT_FAILED
  UNDER_REVIEW
  EXPIRED
}

enum JobType {
  FULL_TIME
  PART_TIME
  CONTRACT
  INTERNSHIP
  TEMPORARY
}

enum ApplicationStatus {
  NEW
  REVIEWING
  PHONE_SCREEN
  TECHNICAL_TEST
  INTERVIEW_SCHEDULED
  INTERVIEWED
  REFERENCE_CHECK
  OFFER_EXTENDED
  OFFER_ACCEPTED
  REJECTED
  WITHDRAWN
  HIRED
}

enum EarningsTier {
  BASIC
  STANDARD
  PREMIUM
}

enum InsuranceStatus {
  NONE
  PENDING
  ACTIVE
  INACTIVE
  DEACTIVATED
  EXPIRED
  SUSPENDED
}

enum GovernmentIdType {
  PASSPORT
  STATE_ID
  NATIONAL_ID
  DRIVERS_LICENSE
}

enum MemberTier {
  BRONZE
  SILVER
  GOLD
  PLATINUM
  DIAMOND
}

enum SuspensionLevel {
  SOFT
  HARD
  BANNED
}

enum ModerationType {
  WARNING
  SUSPEND
  UNSUSPEND
  BAN
  UNBAN
  RESTRICTION_ADDED
  RESTRICTION_REMOVED
  NOTE_ADDED
}

enum AppealStatus {
  PENDING
  UNDER_REVIEW
  APPROVED
  DENIED
  WITHDRAWN
}

enum WarningCategory {
  LATE_RETURNS
  VEHICLE_DAMAGE
  CLEANLINESS_ISSUES
  MILEAGE_VIOLATIONS
  POLICY_VIOLATIONS
  FRAUDULENT_ACTIVITY
  PAYMENT_ISSUES
  COMMUNICATION_ISSUES
  INAPPROPRIATE_BEHAVIOR
  UNAUTHORIZED_DRIVER
  SMOKING_VIOLATION
  PET_VIOLATION
  FUEL_VIOLATIONS
  DOCUMENTATION_ISSUES
  OTHER
}

enum VehicleCategory {
  ECONOMY
  STANDARD
  PREMIUM
  LUXURY
  EXOTIC
  SUPERCAR
}

// Vehicle listing type - determines where vehicle appears
enum VehicleType {
  RENTAL    // Shows on /rentals (1+ day booking)
  RIDESHARE // Shows on /rideshare (3+ day minimum)
}

enum RiskCategory {
  LOW
  MEDIUM
  HIGH
  EXTREME
}

enum CoverageOverrideType {
  FULL_APPROVAL
  PARTIAL_APPROVAL
  CUSTOM_PRICING
  TIER_RESTRICTION
  TEMPORARY_APPROVAL
  MANUAL_REVIEW
}

enum ServiceType {
  OIL_CHANGE
  STATE_INSPECTION
  TIRE_ROTATION
  BRAKE_CHECK
  FLUID_CHECK
  BATTERY_CHECK
  AIR_FILTER
  MAJOR_SERVICE_30K
  MAJOR_SERVICE_60K
  MAJOR_SERVICE_90K
  CUSTOM
}

enum MergeStatus {
  PENDING          // Request created, waiting for verification
  GUEST_CONFIRMED  // Guest clicked link, waiting for host confirmation
  VERIFIED         // Code verified, ready to assign legacy ID
  COMPLETED        // Legacy ID assigned to both accounts
  REJECTED         // User rejected the merge
  EXPIRED          // Verification code expired
}

// ============================================================================
// FLEET PARTNER ENUMS (B2B SaaS)
// ============================================================================

enum PartnerPayoutSchedule {
  DAILY
  WEEKLY
  BIWEEKLY
  MONTHLY
}

enum PartnerApplicationStatus {
  DRAFT
  SUBMITTED
  UNDER_REVIEW
  APPROVED
  REJECTED
}

enum PartnerDocumentType {
  BUSINESS_LICENSE
  INSURANCE_CERTIFICATE
  COMMERCIAL_AUTO_POLICY
  BACKGROUND_CHECK
  W9_FORM
  ARTICLES_OF_INCORPORATION
}

enum PartnerDocumentStatus {
  PENDING
  VERIFIED
  REJECTED
  EXPIRED
}

enum PartnerPayoutStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

// ============================================================================
// FLEET MANAGER & VEHICLE OWNER ENUMS
// ============================================================================

enum VehicleManagementStatus {
  PENDING
  ACTIVE
  PAUSED
  TERMINATED
}

enum ManagementInvitationType {
  OWNER_INVITES_MANAGER
  MANAGER_INVITES_OWNER
}

enum ManagementInvitationStatus {
  PENDING
  COUNTER_OFFERED
  ACCEPTED
  DECLINED
  EXPIRED
  CANCELLED
}
